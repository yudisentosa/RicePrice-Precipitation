---
title: "Perbandingan model ARIMAX-GARCH dan SVR pada harga beras dengan variabel eksogen curah hujan"
author: "Yudiestira Dwi Sentosa"
date: "31/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Export data and library

```{r export data and library, results='hide', warning=FALSE}
#install.packages("lubridate")
#for imputation
library(dlookr)
library(visdat)
library(plotly)
library(imputeTS)
library(missRanger)
#for data processing and visualization
library(gam) # GeneralizedAdditiveModels
library(dplyr) #data mutate
library(tidyverse) # data cleaning
library(ggplot2) #data visualization
#Time series
library(TSA) #For modelling arimax
library(lmtest)  #contains coeftest function
library(tseries)
library(forecast) #For modelling Arima() with xreg
library(nortsTest) #for heteroscedasticity test 
library(quantmod)  # to create the Lags
library(aTSA) #for arch.test
library(fGarch) 
library(caretForecast) # For modelling SVR
library(xts) #time series data with date value rownames
library(rugarch) #for modelling GARCH
library(MLmetrics) #for mape function
#Misc
library(scales)
library(skedastic)
library(outliers) #for checking outliers
library(EnvStats) #for box-cox transformation
library(MASS) #for box-cox test
library(DescTools) #automatic box-cox
library(lubridate) 
#No need
library(fpp2) # data sampel

setwd("D:/Mirror/zz/Universitas/T5 Semester 9/Tugas Akhir 2/KERJAKAN")
data_klimatologi_jawa <-
  as.data.frame(read_csv("all_data_klimatologi_jawa.csv"))
data_beras_jawa <-
  as.data.frame(read_csv("all_data_beras_jawa_mingguan.csv"))

#create weekly time frame data
data_klimatologi_jawa <- 
  mutate(data_klimatologi_jawa, 
         yearweeknum = 
           case_when(
             tanggal == as.Date("2018-12-31") ~ "2019-1",
             tanggal == as.Date("2019-12-30") ~ "2020-1",
             tanggal == as.Date("2019-12-31") ~ "2020-1",
             TRUE ~ 
               paste(year(data_klimatologi_jawa$tanggal),     
                     isoweek(data_klimatologi_jawa$tanggal),
                     sep = "-")))
```

```{r defined variable klimatologi}

#data klimatologi
data_klimatologi_serang <- subset(data_klimatologi_jawa, kota == "Serang")
data_klimatologi_jakarta <- subset(data_klimatologi_jawa, kota == "Jakarta")
data_klimatologi_bandung <- subset(data_klimatologi_jawa, kota == "Bandung")
data_klimatologi_semarang <- subset(data_klimatologi_jawa, kota == "Semarang")
data_klimatologi_jogja <- subset(data_klimatologi_jawa, kota == "Yogyakarta")
data_klimatologi_surabaya <- subset(data_klimatologi_jawa, kota == "Surabaya")
data_klimatologi_malang <- subset(data_klimatologi_jawa, kota == "Malang")

data_klimatologi_serang <- missRanger(
  data_klimatologi_serang,
  formula = . ~ .,
  num.trees = 100,
  seed = 3
)

data_klimatologi_jakarta <- missRanger(
  data_klimatologi_jakarta,
  formula = . ~ .,
  num.trees = 100,
  seed = 3
)

data_klimatologi_bandung <- missRanger(
  data_klimatologi_bandung,
  formula = . ~ .,
  num.trees = 100,
  seed = 3
)

data_klimatologi_semarang <- missRanger(
  data_klimatologi_semarang,
  formula = . ~ .,
  num.trees = 100,
  seed = 3
)

data_klimatologi_jogja <- missRanger(
  data_klimatologi_jogja,
  formula = . ~ .,
  num.trees = 100,
  seed = 3
)

data_klimatologi_surabaya <- missRanger(
  data_klimatologi_surabaya,
  formula = . ~ .,
  num.trees = 100,
  seed = 3
)

data_klimatologi_malang <- missRanger(
  data_klimatologi_malang,
  formula = . ~ .,
  num.trees = 100,
  seed = 3
)

#Transform to weekly data
data_klimatologi_serang_week <- data_klimatologi_serang%>%
  group_by(yearweeknum) %>%
  summarise(Tn = min(Tn),
            Tx = max(Tx),
            Tavg = mean(Tavg),
            RH_avg = mean(RH_avg),
            RR = sum(RR),
            ss = sum(ss),
            ff_x = max(ff_x),
            ddd_x = mean(ddd_x))


data_klimatologi_jakarta_week <- data_klimatologi_jakarta%>%
  group_by(yearweeknum) %>%
  summarise(Tn = min(Tn),
            Tx = max(Tx),
            Tavg = mean(Tavg),
            RH_avg = mean(RH_avg),
            RR = sum(RR),
            ss = sum(ss),
            ff_x = max(ff_x),
            ddd_x = mean(ddd_x))


data_klimatologi_bandung_week <- data_klimatologi_bandung%>%
  group_by(yearweeknum) %>%
  summarise(Tn = min(Tn),
            Tx = max(Tx),
            Tavg = mean(Tavg),
            RH_avg = mean(RH_avg),
            RR = sum(RR),
            ss = sum(ss),
            ff_x = max(ff_x),
            ddd_x = mean(ddd_x))


data_klimatologi_semarang_week <- data_klimatologi_semarang%>%
  group_by(yearweeknum) %>%
  summarise(Tn = min(Tn),
            Tx = max(Tx),
            Tavg = mean(Tavg),
            RH_avg = mean(RH_avg),
            RR = sum(RR),
            ss = sum(ss),
            ff_x = max(ff_x),
            ddd_x = mean(ddd_x))


data_klimatologi_jogja_week <- data_klimatologi_jogja%>%
  group_by(yearweeknum) %>%
  summarise(Tn = min(Tn),
            Tx = max(Tx),
            Tavg = mean(Tavg),
            RH_avg = mean(RH_avg),
            RR = sum(RR),
            ss = sum(ss),
            ff_x = max(ff_x),
            ddd_x = mean(ddd_x))


data_klimatologi_surabaya_week <- data_klimatologi_surabaya%>%
  group_by(yearweeknum) %>%
  summarise(Tn = min(Tn),
            Tx = max(Tx),
            Tavg = mean(Tavg),
            RH_avg = mean(RH_avg),
            RR = sum(RR),
            ss = sum(ss),
            ff_x = max(ff_x),
            ddd_x = mean(ddd_x))


data_klimatologi_malang_week <- data_klimatologi_malang%>%
  group_by(yearweeknum) %>%
  summarise(Tn = min(Tn),
            Tx = max(Tx),
            Tavg = mean(Tavg),
            RH_avg = mean(RH_avg),
            RR = sum(RR),
            ss = sum(ss),
            ff_x = max(ff_x),
            ddd_x = mean(ddd_x))

```


## Serang

```{r pre-processing data}
#data harga beras
data_beras_serang_rawu <- 
  subset(data_beras_jawa, 
  kota == "Serang" & pasar == "Pasar Rawu")

data_beras_serang_royal_lama <- 
  subset(data_beras_jawa, 
         kota == "Serang" & pasar == "Pasar Royal Lama")

#bagi menjadi 3 kualitas
beras_low_serang_rawu <- 
  subset(data_beras_serang_rawu, 
         komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_serang_rawu <- 
  subset(data_beras_serang_rawu, 
  komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_serang_rawu <- 
  subset(data_beras_serang_rawu, 
  komoditas == 'Beras Kualitas Super I (kg)')

beras_low_serang_royal_lama <- 
  subset(data_beras_serang_royal_lama, 
         komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_serang_royal_lama <-
  subset(data_beras_serang_royal_lama, 
         komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_serang_royal_lama <- 
  subset(data_beras_serang_royal_lama, 
         komoditas == 'Beras Kualitas Super I (kg)')

#impute data
beras_low_serang_rawu$harga <- 
  na_interpolation(beras_low_serang_rawu$harga)
beras_med_serang_rawu$harga <- 
  na_interpolation(beras_med_serang_rawu$harga)
beras_high_serang_rawu$harga <- 
  na_interpolation(beras_high_serang_rawu$harga)

beras_low_serang_royal_lama$harga <- 
  na_interpolation(beras_low_serang_royal_lama$harga)
beras_med_serang_royal_lama$harga <- 
  na_interpolation(beras_med_serang_royal_lama$harga)
beras_high_serang_royal_lama$harga <- 
  na_interpolation(beras_high_serang_royal_lama$harga)

#gabung semua pasar terhadap kualitasnya
##LOW - SERANG
beras_low_serang <- 
  merge(x=beras_low_serang_rawu,
        y=dplyr::select(beras_low_serang_royal_lama,-tanggal),
                        by="yearweeknum",
                        all.x=TRUE,
                        all.y=TRUE) %>% 
  mutate(harga = (harga.x + harga.y)/2)

data_low_serang <-
  merge(
    x=dplyr::select(beras_low_serang,tanggal,
                    yearweeknum,harga),
    y=data_klimatologi_serang_week, 
    by="yearweeknum", 
    all.x=TRUE) %>% arrange(tanggal)

##MED - SERANG
beras_med_serang <- 
  merge(x=beras_med_serang_rawu,
        y=dplyr::select(beras_med_serang_royal_lama,-tanggal),
        by="yearweeknum",
        all.x=TRUE,
        all.y=TRUE) %>% 
  mutate(harga = (harga.x + harga.y)/2)

data_med_serang <-
  merge(x=dplyr::select(beras_med_serang,tanggal,
                        yearweeknum,harga),
        y=data_klimatologi_serang_week, 
        by="yearweeknum",
        all.x=TRUE) %>% arrange(tanggal)

##HIGH - SERANG
beras_high_serang <- 
  merge(x=beras_high_serang_rawu,
        y=dplyr::select(beras_high_serang_royal_lama,-tanggal),
        by="yearweeknum",
        all.x=TRUE,
        all.y=TRUE) %>% 
  mutate(harga = (harga.x + harga.y)/2)

data_high_serang <- 
  merge(x=dplyr::select(beras_high_serang,
                        tanggal,yearweeknum,harga),
        y=data_klimatologi_serang_week,
        by="yearweeknum",
        all.x=TRUE) %>% 
  arrange(tanggal)

###DIVIDE to TRAIN and TEST
data_low_serang_train <- data_low_serang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_serang))),]
data_low_serang_test <- data_low_serang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_serang))),]

data_med_serang_train <- data_med_serang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_serang))),]
data_med_serang_test <- data_med_serang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_serang))),]

data_high_serang_train <- data_high_serang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_serang))),]
data_high_serang_test <- data_high_serang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_serang))),]

View(data_high_serang_train)

```

```{r ploting data harga, warning=FALSE}
#perbandingan sebelum dan sesudah imputation untuk kolom harga

gridExtra::grid.arrange(
  autoplot(xts(data_low_serang$harga, order.by = data_low_serang$tanggal)) + xlab("") + ylab("harga") + ggtitle("Kualitas Rendah"),
  autoplot(xts(data_med_serang$harga, order.by = data_med_serang$tanggal)) + ggtitle("Kualitas Medium") + xlab("") + ylab("harga"),
  autoplot(xts(data_high_serang$harga, order.by = data_high_serang$tanggal)) + ggtitle("Kualitas Premium") + xlab("tanggal") + ylab("harga"),
  top = "Harga Beras Serang"
  ) 

#convert to time series data
# data_low_serang_train <- ts(data_low_serang_train,freq=365.25/7, 
#             start=decimal_date(ymd("2017-07-31")))
# data_low_serang_test <- ts(data_low_serang_test,freq=365.25/7, 
#              start=decimal_date(ymd("2021-09-06")))


```

###Serang - Low
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_low_serang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#correlation test
cor.test(data_high_malang$harga, data_high_malang$RR, method = ("pearson"))

#dibutuhkan log transform pada kedua data

fit_beras_low_serang.lm <- lm(log(harga) ~ log1p(RR), data=data_low_serang_train)

grangertest(log1p(RR) ~ log(harga) , data=data_low_surabaya, order = 1)


coeftest(fit_beras_low_serang.lm)
summary(fit_beras_low_serang.lm)
# auto.arima(data_low_serang_train[,"harga"], xreg = log1p(data_low_serang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(diff(fit_beras_low_serang.lm$residuals))
# auto.arima(fit_beras_low_serang.lm$residuals)

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_low_serang.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_low_serang.lm$residuals),1)) #data harga beras stasioner

eacf(fit_beras_low_serang.lm$residuals, ma.max=7) 

temp.model <- list(c(1,1,0),c(1,1,1),c(2,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_low_serang.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(1,1,0)



#model arima
res_beras_low_serang.m1 <- 
  Arima(fit_beras_low_serang.lm$residuals, 
        order=c(1,1,0))
summary(res_beras_low_serang.m1)
coeftest(res_beras_low_serang.m1)
checkresiduals(res_beras_low_serang.m1)
shapiro.test(res_beras_low_serang.m1$residuals)
jarque.bera.test(res_beras_low_serang.m1$residuals)
#white noise

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel terikat = harga
#variabel independen = curah hujan

ccf_low_serang <- 
  prewhiten(x=data_low_serang_train[,"harga"],
            y=data_low_serang_train[,"RR"])
ccf_low_serang$ccf


##Menentukan nilai b,r,s (fungsi transfer)
#dipilih nilai s yang besar, untuk melihat pola dari tes koefisien
xlag_low_serang <- Lag(ts(log1p(data_low_serang_train[,"RR"])),1)
xlag_low_serang[is.na(xlag_low_serang)]=0
fit_beras_low_serang.TFX_temp <-
  arimax(ts(log(data_low_serang_train[,"harga"])),
         order=c(1,1,0),
         xtransf = xlag_low_serang, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_low_serang.TFX_temp)
#signifikan pada MA0
#dilakukan plotting pada bar chart untuk melihat pola
barplot(coef(fit_beras_low_serang.TFX_temp)[-(1:2)])
#dari pola yang didapatkan nilai r = 0
#nilai s yang didapatkan adalah s = 0

```

```{r Fungsi Transfer 2}

fit_beras_low_serang.TFX <- 
  arimax(ts(log(data_low_serang_train[,"harga"])),
         order=c(1,1,0),
         xtransf = xlag_low_serang,
         transfer = list(c(0,0)),
         include.mean = TRUE,
         method="ML") 

coef(fit_beras_low_serang.TFX)
fit_beras_low_serang.TFX$model



beras_low_serang.tx <- 
  stats::filter(xlag_low_serang, 
 exp(coef(fit_beras_low_serang.TFX)[c(2)]),
                method="convolution",
                sides = 1)

fit_beras_low_serang.TF <- 
  Arima(data_low_serang_train$harga,
        xreg = beras_low_serang.tx,
        lambda = 0,
        order=c(1,1,0))

checkresiduals(fit_beras_low_serang.TF)
shapiro.test(fit_beras_low_serang.TF$residuals)
jarque.bera.test(fit_beras_low_serang.TF$residuals)
#residual tidak berdistribusi normal
autoplot(fit_beras_low_serang.TF)
#nilai phi ok

summary(fit_beras_low_serang.TFX)
summary(fit_beras_low_serang.TF) #nilai xreg=1

```

```{r ARIMAX, warning=FALSE}

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_low_serang.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)

forecast_low_serang.TF <-
  forecast::forecast(fit_beras_low_serang.TF,
                     xreg = log1p(data_low_serang_test$RR))

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_low_serang_test[,"tanggal"],
      y = as.numeric(data_low_serang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_serang_test[,"tanggal"],
      y = as.numeric(forecast_low_serang.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Serang")


#accuracy
MAPE(forecast_low_serang.TF$mean,data_low_serang_test$harga)
(postFit_beras_low_serang.TF <- 
caret::postResample(data_low_serang_train$harga,fit_beras_low_serang.TF$fitted))



```

```{r SVR}

#Fitting coarse grid
model_temp <- ARml(ts(data_low_serang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
))
# ,xreg=xts(log1p(data_low_serang_train$RR), order.by=data_low_serang_train$tanggal))

plot(model_temp$model)


#Fitting finer grid
fit_beras_low_serang.SVR <- ARml(ts(data_low_serang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = c('center', 'scale'), tune_grid = expand.grid(
  C=c(60,80,100,120,140),
  sigma=c(0.001, 0.002, 0.005, 0.01, 0.015)
))
,xreg=xts(log1p(data_low_serang_train$RR), order.by=data_low_serang_train$tanggal))

plot(fit_beras_low_serang.SVR$model)
#Fitting sigma = 0.001, C = 80

```




```{r forecast}

forecast_low_serang.SVR <- caretForecast::forecast(fit_beras_low_serang.SVR, level = NULL, xreg = xts(log1p(data_low_serang_test$RR), order.by=as.Date(as.numeric(data_low_serang_test[,"tanggal"]))))


gridExtra::grid.arrange(
  autoplot(forecast_low_serang.TF) + ylab("harga") +
    autolayer(ts(data_low_serang$harga, frequency = 365.25/7, start = decimal_date(ymd("2017-07-31"))),series="Real data"),
  autoplot(forecast_low_serang.SVR) + ylab("harga") +
    autolayer(ts(data_low_serang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_low_serang_test[,"tanggal"],
      y = as.numeric(data_low_serang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_serang_test[,"tanggal"],
      y = as.numeric(forecast_low_serang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Serang")

#accuracy SVR
MAPE(forecast_low_serang.SVR$mean,data_low_serang_test$harga)
(postFit_beras_low_serang.SVR <- 
caret::postResample(data_low_serang_train$harga[-c(1:fit_beras_low_serang.SVR$max_lag+1)],na.omit(fit_beras_low_serang.SVR$fitted)))

```

```{r akurasi model}
accuracy(forecast_low_serang.TF,data_low_serang_test$harga)
accuracy(forecast_low_serang.SVR,data_low_serang_test$harga)

MAPE(forecast_low_serang.TF$mean,data_low_serang_test$harga)
MAPE(forecast_low_serang.SVR$mean,data_low_serang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_low_serang.TF <- 
caret::postResample(data_low_serang_train$harga,fit_beras_low_serang.TF$fitted)

postFit_beras_low_serang.SVR <- 
caret::postResample(data_low_serang_train$harga[-c(1:fit_beras_low_serang.SVR$max_lag+1)],na.omit(fit_beras_low_serang.SVR$fitted))

postFit_beras_low_serang <-
  matrix(c(postFit_beras_low_serang.TF["RMSE"],
                postFit_beras_low_serang.TF["MAE"],
                postFit_beras_low_serang.TF["Rsquared"],
                postFit_beras_low_serang.SVR["RMSE"],
                postFit_beras_low_serang.SVR["MAE"],
                postFit_beras_low_serang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_low_serang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_low_serang) <- c('ARIMAX','SVR')
postFit_beras_low_serang <- round(as.table(postFit_beras_low_serang),4)

###Hasil Error data Test
(postTest_beras_low_serang.TF <- 
caret::postResample(data_low_serang_test$harga,forecast_low_serang.TF$mean))

(postTest_beras_low_serang.SVR <- 
caret::postResample(data_low_serang_test$harga,forecast_low_serang.SVR$mean))

postTest_beras_low_serang <-
  matrix(c(postTest_beras_low_serang.TF["RMSE"],
                postTest_beras_low_serang.TF["MAE"],
                postTest_beras_low_serang.TF["Rsquared"],
                postTest_beras_low_serang.SVR["RMSE"],
                postTest_beras_low_serang.SVR["MAE"],
                postTest_beras_low_serang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_low_serang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_low_serang) <- c('ARIMAX','SVR')
postTest_beras_low_serang <- round(as.table(postTest_beras_low_serang),4)

paste0("Model Fitting Error")
postFit_beras_low_serang
paste0("Model Testing Error")
postTest_beras_low_serang

# plot(beras_low_serang.m1$x,col="red") +
# lines(fitted(beras_low_serang.m1),col="blue")
# 
# plot(fit_beras_low_serang.lm$x,col="red") +
# lines(fitted(fit_beras_low_serang.lm),col="blue")


```



###Serang - Med
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_med_serang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_med_serang.lm <- lm(log(harga) ~ log1p(RR), data=data_med_serang_train)

coeftest(fit_beras_med_serang.lm)
summary(fit_beras_med_serang.lm)
# auto.arima(data_med_serang_train[,"harga"], xreg = log1p(data_med_serang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_med_serang.lm$residuals)
# auto.arima(fit_beras_med_serang.lm$residuals)

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_med_serang.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_med_serang.lm$residuals),1)) #data harga beras stasioner

eacf(diff(fit_beras_med_serang.lm$residuals,1), ma.max=7) 

auto.arima(fit_beras_med_serang.lm$residuals, stepwise=F, approximation = F)

temp.model <- list(c(1,1,0),c(1,1,2),c(2,1,2),c(2,1,3))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_med_serang.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(2,1,3)



#model arima
res_beras_med_serang.m1 <- 
  Arima(fit_beras_med_serang.lm$residuals, 
        order=c(2,1,3))
summary(res_beras_med_serang.m1)
coeftest(res_beras_med_serang.m1)
checkresiduals(res_beras_med_serang.m1)
shapiro.test(res_beras_med_serang.m1$residuals)
#white noise


summary(Arima(ts(data_med_serang_train$harga), 
        order=c(1,1,0),
      xreg = log1p(data_med_serang_train$RR),
      lambda = 0))
```


```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_med_serang <- 
  prewhiten(x=data_med_serang_train$harga,
            y=data_med_serang_train$RR)
ccf_med_serang$ccf 

##Menentukan nilai b,r,s (fungsi transfer)
#dipilih nilai s yang besar, untuk melihat pola dari tes koefisien
xlag_med_serang <- Lag(ts(log1p(data_med_serang_train[,"RR"])),1)
xlag_med_serang[is.na(xlag_med_serang)]=0
fit_beras_med_serang.TFX_temp <-
  arimax(ts(log(data_med_serang_train[,"harga"])),
         order=c(1,1,0),
         xtransf = xlag_med_serang, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_med_serang.TFX_temp)
#signifikan pada MA0
#dilakukan plotting pada bar chart untuk melihat pola
barplot(coef(fit_beras_med_serang.TFX_temp)[-(1:2)])
#dari pola yang didapatkan nilai r = 0
#nilai s yang didapatkan adalah s = 0

```

```{r Fungsi Transfer 2}

fit_beras_med_serang.TFX <- 
  arimax(ts(log(data_med_serang_train[,"harga"])),
         order=c(1,1,0),
         xtransf = xlag_med_serang,
         transfer = list(c(0,0)),
         include.mean = TRUE,
         method="ML") 

coef(fit_beras_med_serang.TFX)
fit_beras_med_serang.TFX$model



beras_med_serang.tx <- 
  stats::filter(xlag_med_serang, 
 exp(coef(fit_beras_med_serang.TFX)[c(2)]),
                method="convolution",
                sides = 1)

fit_beras_med_serang.TF <- 
  Arima(data_med_serang_train$harga,
        xreg = beras_med_serang.tx,
        lambda = 0,
        order=c(1,1,0))

checkresiduals(fit_beras_med_serang.TF)
shapiro.test(fit_beras_med_serang.TF$residuals)
#residual tidak berdistribusi normal
autoplot(fit_beras_med_serang.TF)
#nilai phi ok

summary(fit_beras_med_serang.TFX)
summary(fit_beras_med_serang.TF) #nilai xreg=1

```


```{r ARIMAX, warning=FALSE}

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_med_serang.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)

forecast_med_serang.TF <-
  forecast::forecast(fit_beras_med_serang.TF,
                     xreg = log1p(data_med_serang_test$RR))

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_med_serang_test[,"tanggal"],
      y = as.numeric(data_med_serang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_serang_test[,"tanggal"],
      y = as.numeric(forecast_med_serang.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Serang")


#accuracy
MAPE(forecast_med_serang.TF$mean,data_med_serang_test$harga)
(postTest_beras_med_serang.TF <- 
caret::postResample(data_med_serang_test$harga,forecast_med_serang.TF$mean))


```

```{r SVR}
model_temp <- ARml(ts(data_med_serang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_med_serang_train$RR), order.by=data_med_serang_train$tanggal))

plot(model_temp$model)


fit_beras_med_serang.SVR <- ARml(ts(data_med_serang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(1,0.5,0.2,0.1),
  sigma=c(0.01, 0.005, 0.001, 0.0005)
),xreg=xts(log1p(data_med_serang_train$RR), order.by=data_med_serang_train$tanggal))

plot(fit_beras_med_serang.SVR$model)


#Fitting sigma = 0.01, C = 0.5

```



```{r forecast}
forecast_med_serang.TF <-
  forecast::forecast(fit_beras_med_serang.TF,
                     xreg = log1p(data_med_serang_test$RR))


forecast_med_serang.SVR <- caretForecast::forecast(fit_beras_med_serang.SVR, level = NULL, xreg = xts(log1p(data_med_serang_test$RR), order.by=as.Date(as.numeric(data_med_serang_test[,"tanggal"]))))


gridExtra::grid.arrange(
  autoplot(forecast_med_serang.TF) + ylab("harga") +
    autolayer(ts(data_med_serang$harga, frequency = 365.25/7, start = decimal_date(ymd("2017-07-31"))),series="Real data"),
  autoplot(forecast_med_serang.SVR) + ylab("harga") +
    autolayer(ts(data_med_serang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_med_serang_test[,"tanggal"],
      y = as.numeric(data_med_serang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_serang_test[,"tanggal"],
      y = as.numeric(forecast_med_serang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted med Quailty Rice Price Serang")

```

```{r akurasi model}
accuracy(forecast_med_serang.TF,data_med_serang_test$harga)
accuracy(forecast_med_serang.SVR,data_med_serang_test$harga)

MAPE(forecast_med_serang.TF$mean,data_med_serang_test$harga)
MAPE(forecast_med_serang.SVR$mean,data_med_serang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_med_serang.TF <- 
caret::postResample(data_med_serang_train$harga,fit_beras_med_serang.TF$fitted)

(postFit_beras_med_serang.SVR <- 
caret::postResample(data_med_serang_train$harga[-c(1:fit_beras_med_serang.SVR$max_lag+1)],na.omit(fit_beras_med_serang.SVR$fitted)))

postFit_beras_med_serang <-
  matrix(c(postFit_beras_med_serang.TF["RMSE"],
                postFit_beras_med_serang.TF["MAE"],
                postFit_beras_med_serang.TF["Rsquared"],
                postFit_beras_med_serang.SVR["RMSE"],
                postFit_beras_med_serang.SVR["MAE"],
                postFit_beras_med_serang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_med_serang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_med_serang) <- c('ARIMAX','SVR')
postFit_beras_med_serang <- round(as.table(postFit_beras_med_serang),4)

###Hasil Error data Test
(postTest_beras_med_serang.TF <- 
caret::postResample(data_med_serang_test$harga,forecast_med_serang.TF$mean))

(postTest_beras_med_serang.SVR <- 
caret::postResample(data_med_serang_test$harga,forecast_med_serang.SVR$mean))

postTest_beras_med_serang <-
  matrix(c(postTest_beras_med_serang.TF["RMSE"],
                postTest_beras_med_serang.TF["MAE"],
                postTest_beras_med_serang.TF["Rsquared"],
                postTest_beras_med_serang.SVR["RMSE"],
                postTest_beras_med_serang.SVR["MAE"],
                postTest_beras_med_serang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_med_serang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_med_serang) <- c('ARIMAX','SVR')
postTest_beras_med_serang <- round(as.table(postTest_beras_med_serang),4)

paste0("Model Fitting Error")
postFit_beras_med_serang
paste0("Model Testing Error")
postTest_beras_med_serang

# plot(beras_med_serang.m1$x,col="red") +
# lines(fitted(beras_med_serang.m1),col="blue")
# 
# plot(fit_beras_med_serang.lm$x,col="red") +
# lines(fitted(fit_beras_med_serang.lm),col="blue")


```


###Serang - High
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_high_serang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_high_serang.lm <- lm(log(harga) ~ log1p(RR), data=data_high_serang_train)

coeftest(fit_beras_high_serang.lm)
summary(fit_beras_high_serang.lm)
# auto.arima(data_high_serang_train[,"harga"], xreg = log1p(data_high_serang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_high_serang.lm$residuals)
# auto.arima(fit_beras_high_serang.lm$residuals)

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_high_serang.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_high_serang.lm$residuals),1)) #data harga beras stasioner

eacf(diff(fit_beras_high_serang.lm$residuals,1), ma.max=7) 

auto.arima(fit_beras_high_serang.lm$residuals, stepwise=F, approximation = F)

temp.model <- list(c(1,1,0),c(0,1,1),c(1,1,1),c(1,1,2))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_high_serang.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,1)


#model arima
res_beras_high_serang.m1 <- 
  Arima(fit_beras_high_serang.lm$residuals, 
        order=c(0,1,1))
summary(res_beras_high_serang.m1)
coeftest(res_beras_high_serang.m1)
checkresiduals(res_beras_high_serang.m1)
shapiro.test(res_beras_high_serang.m1$residuals)
#white noise


summary(Arima(ts(data_high_serang_train$harga), 
        order=c(0,1,1),
      xreg = log1p(data_high_serang_train$RR),
      lambda = 0))
```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_high_serang <- 
  prewhiten(x=data_high_serang_train$harga,
            y=data_high_serang_train$RR)
ccf_high_serang$ccf 

##Menentukan nilai b,r,s (fungsi transfer)
#dipilih nilai s yang besar, untuk melihat pola dari tes koefisien
xlag_high_serang <- Lag(ts(log1p(data_high_serang_train[,"RR"])),1)
xlag_high_serang[is.na(xlag_high_serang)]=0
fit_beras_high_serang.TFX_temp <-
  arimax(ts(log(data_high_serang_train[,"harga"])),
         order=c(0,1,1),
         xtransf = xlag_high_serang, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_high_serang.TFX_temp)
#signifikan pada MA0
#dilakukan plotting pada bar chart untuk melihat pola
barplot(coef(fit_beras_high_serang.TFX_temp)[-(1:2)])
#dari pola yang didapatkan nilai r = 0
#nilai s yang didapatkan adalah s = 0

```

```{r Fungsi Transfer 2}

fit_beras_high_serang.TFX <- 
  arimax(ts(log(data_high_serang_train[,"harga"])),
         order=c(0,1,1),
         xtransf = xlag_high_serang,
         transfer = list(c(0,0)),
         include.mean = TRUE,
         method="ML") 

coef(fit_beras_high_serang.TFX)
fit_beras_high_serang.TFX$model

beras_high_serang.tx <- 
  stats::filter(xlag_high_serang, 
 exp(coef(fit_beras_high_serang.TFX)[c(2)]),
                method="convolution",
                sides = 1)

fit_beras_high_serang.TF <- 
  Arima(data_high_serang_train$harga,
        xreg = beras_high_serang.tx,
        lambda = 0,
        order=c(0,1,1))

checkresiduals(fit_beras_high_serang.TF)
shapiro.test(fit_beras_high_serang.TF$residuals)
#residual tidak berdistribusi normal
autoplot(fit_beras_high_serang.TF)
#nilai phi ok

summary(fit_beras_high_serang.TFX)
summary(fit_beras_high_serang.TF) #nilai xreg=1

```


```{r ARIMAX, warning=FALSE}

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_high_serang.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)

forecast_high_serang.TF <-
  forecast::forecast(fit_beras_high_serang.TF,
                     xreg = log1p(data_high_serang_test$RR))



#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_high_serang_test[,"tanggal"],
      y = as.numeric(data_high_serang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_serang_test[,"tanggal"],
      y = as.numeric(forecast_high_serang.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted High Quailty Rice Price Serang")


#accuracy
MAPE(forecast_high_serang.TF$mean,data_high_serang_test$harga)
(postFit_beras_high_serang.TF <- 
caret::postResample(data_high_serang_train$harga,fit_beras_high_serang.TF$fitted))



```


```{r SVR}
model_temp <- ARml(ts(data_high_serang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_high_serang_train$RR), order.by=data_high_serang_train$tanggal))

plot(model_temp$model)


fit_beras_high_serang.SVR <- ARml(ts(data_high_serang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(100,105,110,120),
  sigma=c(0.01, 0.005, 0.001, 0.05)
),xreg=xts(log1p(data_high_serang_train$RR), order.by=data_high_serang_train$tanggal))

plot(fit_beras_high_serang.SVR$model)


#Fitting sigma = 0.01, C = 0.5

```



```{r forecast}
forecast_high_serang.TF <-
  forecast::forecast(fit_beras_high_serang.TF,
                     xreg = log1p(data_high_serang_test$RR))


forecast_high_serang.SVR <- caretForecast::forecast(fit_beras_high_serang.SVR, level = NULL, xreg = xts(log1p(data_high_serang_test$RR), order.by=as.Date(as.numeric(data_high_serang_test[,"tanggal"]))))


gridExtra::grid.arrange(
  autoplot(forecast_high_serang.TF) + ylab("harga") +
    autolayer(ts(data_high_serang$harga, frequency = 365.25/7, start = decimal_date(ymd("2017-07-31"))),series="Real data"),
  autoplot(forecast_high_serang.SVR) + ylab("harga") +
    autolayer(ts(data_high_serang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_high_serang_test[,"tanggal"],
      y = as.numeric(data_high_serang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_serang_test[,"tanggal"],
      y = as.numeric(forecast_high_serang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted high Quailty Rice Price Serang")

```

```{r akurasi model}
accuracy(forecast_high_serang.TF,data_high_serang_test$harga)
accuracy(forecast_high_serang.SVR,data_high_serang_test$harga)

MAPE(forecast_high_serang.TF$mean,data_high_serang_test$harga)
MAPE(forecast_high_serang.SVR$mean,data_high_serang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_high_serang.TF <- 
caret::postResample(data_high_serang_train$harga,fit_beras_high_serang.TF$fitted)

(postFit_beras_high_serang.SVR <- 
caret::postResample(data_high_serang_train$harga[-c(1:fit_beras_high_serang.SVR$max_lag+1)],na.omit(fit_beras_high_serang.SVR$fitted)))

postFit_beras_high_serang <-
  matrix(c(postFit_beras_high_serang.TF["RMSE"],
                postFit_beras_high_serang.TF["MAE"],
                postFit_beras_high_serang.TF["Rsquared"],
                postFit_beras_high_serang.SVR["RMSE"],
                postFit_beras_high_serang.SVR["MAE"],
                postFit_beras_high_serang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_high_serang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_high_serang) <- c('ARIMAX','SVR')
postFit_beras_high_serang <- round(as.table(postFit_beras_high_serang),4)

###Hasil Error data Test
(postTest_beras_high_serang.TF <- 
caret::postResample(data_high_serang_test$harga,forecast_high_serang.TF$mean))

(postTest_beras_high_serang.SVR <- 
caret::postResample(data_high_serang_test$harga,forecast_high_serang.SVR$mean))

postTest_beras_high_serang <-
  matrix(c(postTest_beras_high_serang.TF["RMSE"],
                postTest_beras_high_serang.TF["MAE"],
                postTest_beras_high_serang.TF["Rsquared"],
                postTest_beras_high_serang.SVR["RMSE"],
                postTest_beras_high_serang.SVR["MAE"],
                postTest_beras_high_serang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_high_serang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_high_serang) <- c('ARIMAX','SVR')
postTest_beras_high_serang <- round(as.table(postTest_beras_high_serang),4)

paste0("Model Fitting Error")
postFit_beras_high_serang
paste0("Model Testing Error")
postTest_beras_high_serang

# plot(beras_high_serang.m1$x,col="red") +
# lines(fitted(beras_high_serang.m1),col="blue")
# 
# plot(fit_beras_high_serang.lm$x,col="red") +
# lines(fitted(fit_beras_high_serang.lm),col="blue")

```

## Jakarta

```{r pre-processing data}
#data harga beras
data_beras_jakarta_jatinegara <- subset(data_beras_jawa, 
                            kota == "Jakarta" & pasar == "Pasar Jatinegara")

data_beras_jakarta_kramajati <- subset(data_beras_jawa, 
                            kota == "Jakarta" & pasar == "Pasar Kramajati")

data_beras_jakarta_pasar_minggu <- subset(data_beras_jawa, 
                            kota == "Jakarta" & pasar == "Pasar Minggu")

#bagi menjadi 3 kualitas
beras_low_jakarta_jatinegara <- subset(data_beras_jakarta_jatinegara, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_jakarta_jatinegara <- subset(data_beras_jakarta_jatinegara, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_jakarta_jatinegara <- subset(data_beras_jakarta_jatinegara, 
                            komoditas == 'Beras Kualitas Super I (kg)')

beras_low_jakarta_kramajati <- subset(data_beras_jakarta_kramajati, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_jakarta_kramajati <- subset(data_beras_jakarta_kramajati, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_jakarta_kramajati <- subset(data_beras_jakarta_kramajati, 
                            komoditas == 'Beras Kualitas Super I (kg)')

beras_low_jakarta_pasar_minggu <- subset(data_beras_jakarta_pasar_minggu, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_jakarta_pasar_minggu <- subset(data_beras_jakarta_pasar_minggu, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_jakarta_pasar_minggu <- subset(data_beras_jakarta_pasar_minggu, 
                            komoditas == 'Beras Kualitas Super I (kg)')


#impute data
beras_low_jakarta_jatinegara$harga <- na_interpolation(beras_low_jakarta_jatinegara$harga)
beras_med_jakarta_jatinegara$harga <- na_interpolation(beras_med_jakarta_jatinegara$harga)
beras_high_jakarta_jatinegara$harga <- na_interpolation(beras_high_jakarta_jatinegara$harga)

beras_low_jakarta_kramajati$harga <- na_interpolation(beras_low_jakarta_kramajati$harga)
beras_med_jakarta_kramajati$harga <- na_interpolation(beras_med_jakarta_kramajati$harga)
beras_high_jakarta_kramajati$harga <- na_interpolation(beras_high_jakarta_kramajati$harga)

beras_low_jakarta_pasar_minggu$harga <- na_interpolation(beras_low_jakarta_pasar_minggu$harga)
beras_med_jakarta_pasar_minggu$harga <- na_interpolation(beras_med_jakarta_pasar_minggu$harga)
beras_high_jakarta_pasar_minggu$harga <- na_interpolation(beras_high_jakarta_pasar_minggu$harga)


#gabung semua pasar terhadap kualitasnya
##LOW - JAKARTA
beras_low_jakarta <- merge(merge(beras_low_jakarta_jatinegara, dplyr::select(beras_low_jakarta_kramajati,-tanggal),
                                 by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE), dplyr::select(beras_low_jakarta_pasar_minggu,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% 
mutate(harga = (harga.x + harga.y +harga)/3)


data_low_jakarta <-
merge(x=dplyr::select(beras_low_jakarta,tanggal,yearweeknum,harga),
                     y=data_klimatologi_jakarta_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)


##MED - JAKARTA
beras_med_jakarta <- merge(merge(beras_med_jakarta_jatinegara, dplyr::select(beras_med_jakarta_kramajati,-tanggal),
                                 by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE), dplyr::select(beras_med_jakarta_pasar_minggu,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% 
mutate(harga = (harga.x + harga.y +harga)/3)


data_med_jakarta <- merge(x=dplyr::select(beras_med_jakarta,tanggal,yearweeknum,harga),
                     y=data_klimatologi_jakarta_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)

##HIGH - JAKARTA
beras_high_jakarta <- merge(merge(beras_high_jakarta_jatinegara, dplyr::select(beras_high_jakarta_kramajati,-tanggal),
                                 by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE), dplyr::select(beras_high_jakarta_pasar_minggu,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% 
mutate(harga = (harga.x + harga.y +harga)/3)


data_high_jakarta <- merge(x=dplyr::select(beras_high_jakarta,tanggal,yearweeknum,harga),
                     y=data_klimatologi_jakarta_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)


#bagi data ke dalam train dan fit
data_low_jakarta_train <- data_low_jakarta[seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_jakarta))),]
data_low_jakarta_test <- data_low_jakarta[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_jakarta))),]

data_med_jakarta_train <- data_med_jakarta[seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_jakarta))),]
data_med_jakarta_test <- data_med_jakarta[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_jakarta))),]

data_high_jakarta_train <- data_high_jakarta[seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_jakarta))),]
data_high_jakarta_test <- data_high_jakarta[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_jakarta))),]
```



```{r ploting data harga, warning=FALSE}

gridExtra::grid.arrange(
  autoplot(xts(data_low_jakarta$harga, order.by = data_low_jakarta$tanggal)) + xlab("") + ylab("harga") + ggtitle("Kualitas Rendah"),
  autoplot(xts(data_med_jakarta$harga, order.by = data_med_jakarta$tanggal)) + ggtitle("Kualitas Medium") + xlab("") + ylab("harga"),
  autoplot(xts(data_high_jakarta$harga, order.by = data_high_jakarta$tanggal)) + ggtitle("Kualitas Premium") + xlab("tanggal") + ylab("harga"),
  top = "Harga Beras jakarta"
  ) 

```

###Jakarta - Low
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_low_jakarta_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_low_jakarta.lm <- lm(log(harga) ~ log1p(RR), data=data_low_jakarta_train)

coeftest(fit_beras_low_jakarta.lm)
summary(fit_beras_low_jakarta.lm)
# auto.arima(data_low_jakarta_train[,"harga"], xreg = log1p(data_low_jakarta_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_low_jakarta.lm$residuals)
auto.arima(fit_beras_low_jakarta.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_low_jakarta.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_low_jakarta.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_low_jakarta.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_low_jakarta.lm$residuals),1), ma.max=7) 

temp.model <- list(c(1,1,0),c(0,1,1),c(1,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_low_jakarta.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(1,1,0)



#model arima
res_beras_low_jakarta.m1 <- 
  Arima(fit_beras_low_jakarta.lm$residuals, 
        order=c(1,1,0))
summary(res_beras_low_jakarta.m1)
coeftest(res_beras_low_jakarta.m1)
checkresiduals(res_beras_low_jakarta.m1)
shapiro.test(res_beras_low_jakarta.m1$residuals)
#white noise

Arima(ts(data_low_jakarta_train$harga),
      order = c(1,1,0),
      xreg = ts(log1p(data_low_jakarta_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel terikat = harga
#variabel independen = curah hujan

ccf_low_jakarta <- 
  prewhiten(x=data_low_jakarta_train[,"harga"],
            y=data_low_jakarta_train[,"RR"],
            x.model = Arima(data_low_jakarta_train[,"harga"], order = c(1,0,0)))
ccf_low_jakarta$ccf

# CCF tidak ada yang signifikan, maka tidak dimodelkan fungsi transfer
xlag_low_jakarta <- Lag(ts(log1p(data_low_jakarta_train[,"RR"])),1)
xlag_low_jakarta[is.na(xlag_low_jakarta)]=0
fit_beras_low_jakarta.TFX_temp <-
  arimax(ts(log(data_low_jakarta_train[,"harga"])),
         order=c(1,1,0),
         xtransf = xlag_low_jakarta, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_low_jakarta.TFX_temp)

fit_beras_low_jakarta.TF <- 
  Arima(data_low_jakarta_train$harga,
        xreg = log1p(data_low_jakarta_train$RR),
        lambda = 0,
        order=c(1,1,0))

checkresiduals(fit_beras_low_jakarta.TF)
shapiro.test(fit_beras_low_jakarta.TF$residuals)
autoplot(fit_beras_low_jakarta.TF)
summary(fit_beras_low_jakarta.TF)
coeftest(fit_beras_low_jakarta.TF)
```


```{r ARIMAX, warning=FALSE}

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_low_jakarta.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)

forecast_low_jakarta.TF <-
  forecast::forecast(fit_beras_low_jakarta.TF,
                     xreg = log1p(data_low_jakarta_test$RR))
(postTest_beras_low_jakarta.TF <- 
caret::postResample(data_low_jakarta_test$harga,forecast_low_jakarta.TF$mean))

MAPE(forecast_low_jakarta.TF$mean,data_low_jakarta_test$harga)

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_low_jakarta_test[,"tanggal"],
      y = as.numeric(data_low_jakarta_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_jakarta_test[,"tanggal"],
      y = as.numeric(forecast_low_jakarta.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price jakarta")


#accuracy
MAPE(forecast_low_jakarta.TF$mean,data_low_jakarta_test$harga)
(postFit_beras_low_jakarta.TF <- 
caret::postResample(data_low_jakarta_train$harga,fit_beras_low_jakarta.TF$fitted))



```


```{r SVR}
model_temp <- ARml(ts(data_low_jakarta_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_low_jakarta_train$RR), order.by=data_low_jakarta_train$tanggal))


plot(model_temp$model)


fit_beras_low_jakarta.SVR <- ARml(ts(data_low_jakarta_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(100,95,90,85),
  sigma=c(0.001, 0.002, 0.005, 0.009)
),xreg=xts(log1p(data_low_jakarta_train$RR), order.by=data_low_jakarta_train$tanggal))

plot(fit_beras_low_jakarta.SVR$model)



#Fitting sigma = 0.001, C = 105

```


```{r forecast}
forecast_low_jakarta.TF <-
  forecast::forecast(fit_beras_low_jakarta.TF,
                     xreg = log1p(data_low_jakarta_test$RR))


forecast_low_jakarta.SVR <- caretForecast::forecast(fit_beras_low_jakarta.SVR, level = NULL, xreg = xts(log1p(data_low_jakarta_test$RR), order.by=as.Date(as.numeric(data_low_jakarta_test[,"tanggal"]))))


gridExtra::grid.arrange(
  autoplot(forecast_low_jakarta.TF) + ylab("harga") +
    autolayer(ts(data_low_jakarta$harga, frequency = 365.25/7, start = decimal_date(ymd("2017-07-31"))),series="Real data"),
  autoplot(forecast_low_jakarta.SVR) + ylab("harga") +
    autolayer(ts(data_low_jakarta$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_low_jakarta_test[,"tanggal"],
      y = as.numeric(data_low_jakarta_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_jakarta_test[,"tanggal"],
      y = as.numeric(forecast_low_jakarta.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Serang")

```

```{r akurasi model}
accuracy(forecast_low_jakarta.TF,data_low_jakarta_test$harga)
accuracy(forecast_low_jakarta.SVR,data_low_jakarta_test$harga)

MAPE(forecast_low_jakarta.TF$mean,data_low_jakarta_test$harga)
MAPE(forecast_low_jakarta.SVR$mean,data_low_jakarta_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_low_jakarta.TF <- 
caret::postResample(data_low_jakarta_train$harga,fit_beras_low_jakarta.TF$fitted)

(postFit_beras_low_jakarta.SVR <- 
caret::postResample(data_low_jakarta_train$harga[-c(1:fit_beras_low_jakarta.SVR$max_lag+1)],na.omit(fit_beras_low_jakarta.SVR$fitted)))

postFit_beras_low_jakarta <-
  matrix(c(postFit_beras_low_jakarta.TF["RMSE"],
                postFit_beras_low_jakarta.TF["MAE"],
                postFit_beras_low_jakarta.TF["Rsquared"],
                postFit_beras_low_jakarta.SVR["RMSE"],
                postFit_beras_low_jakarta.SVR["MAE"],
                postFit_beras_low_jakarta.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_low_jakarta) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_low_jakarta) <- c('ARIMAX','SVR')
postFit_beras_low_jakarta <- round(as.table(postFit_beras_low_jakarta),4)

###Hasil Error data Test
(postTest_beras_low_jakarta.TF <- 
caret::postResample(data_low_jakarta_test$harga,forecast_low_jakarta.TF$mean))

(postTest_beras_low_jakarta.SVR <- 
caret::postResample(data_low_jakarta_test$harga,forecast_low_jakarta.SVR$mean))

postTest_beras_low_jakarta <-
  matrix(c(postTest_beras_low_jakarta.TF["RMSE"],
                postTest_beras_low_jakarta.TF["MAE"],
                postTest_beras_low_jakarta.TF["Rsquared"],
                postTest_beras_low_jakarta.SVR["RMSE"],
                postTest_beras_low_jakarta.SVR["MAE"],
                postTest_beras_low_jakarta.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_low_jakarta) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_low_jakarta) <- c('ARIMAX','SVR')
postTest_beras_low_jakarta <- round(as.table(postTest_beras_low_jakarta),4)

paste0("Model Fitting Error")
postFit_beras_low_jakarta
paste0("Model Testing Error")
postTest_beras_low_jakarta

# plot(beras_low_jakarta.m1$x,col="red") +
# lines(fitted(beras_low_jakarta.m1),col="blue")
# 
# plot(fit_beras_low_jakarta.lm$x,col="red") +
# lines(fitted(fit_beras_low_jakarta.lm),col="blue")


```


###Jakarta - Med
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_med_jakarta_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_med_jakarta.lm <- lm(log(harga) ~ log1p(RR), data=data_med_jakarta_train)

coeftest(fit_beras_med_jakarta.lm)
summary(fit_beras_med_jakarta.lm)
# auto.arima(data_med_jakarta_train[,"harga"], xreg = log1p(data_med_jakarta_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_med_jakarta.lm$residuals)
#auto.arima(fit_beras_med_jakarta.lm$residuals)
```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_med_jakarta.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_med_jakarta.lm$residuals),1)) #data harga beras stasioner

eacf(diff(fit_beras_med_jakarta.lm$residuals,1), ma.max=7) 

auto.arima(fit_beras_med_jakarta.lm$residuals, stepwise=F, approximation = F)

temp.model <- list(c(1,1,0),c(1,1,1),c(0,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_med_jakarta.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,1)



#model arima
res_beras_med_jakarta.m1 <- 
  Arima(fit_beras_med_jakarta.lm$residuals, 
        order=c(0,1,1))
summary(res_beras_med_jakarta.m1)
coeftest(res_beras_med_jakarta.m1)
checkresiduals(res_beras_med_jakarta.m1)
shapiro.test(res_beras_med_jakarta.m1$residuals)
#white noise


summary(Arima(ts(data_med_jakarta_train$harga), 
        order=c(0,1,1),
      xreg = log1p(data_med_jakarta_train$RR),
      lambda = 0))
```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_med_jakarta <- 
  prewhiten(x=data_med_jakarta_train$harga,
            y=data_med_jakarta_train$RR)
ccf_med_jakarta$ccf 

# CCF tidak ada yang signifikan, maka tidak dimodelkan fungsi transfer
xlag_med_jakarta <- Lag(ts(log1p(data_med_jakarta_train[,"RR"])),0)
xlag_med_jakarta[is.na(xlag_med_jakarta)]=0
fit_beras_med_jakarta.TFX_temp <-
  arimax(ts(log(data_med_jakarta_train[,"harga"])),
         order=c(0,1,1),
         xtransf = xlag_med_jakarta, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_med_jakarta.TFX_temp)

fit_beras_med_jakarta.TF <- 
  Arima(data_med_jakarta_train$harga,
        xreg = log1p(data_med_jakarta_train$RR),
        lambda = 0,
        order=c(0,1,1))

checkresiduals(fit_beras_med_jakarta.TF)
shapiro.test(fit_beras_med_jakarta.TF$residuals)
autoplot(fit_beras_med_jakarta.TF)
summary(fit_beras_med_jakarta.TF)
coeftest(fit_beras_med_jakarta.TF)

```

```{r ARIMAX, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_med_jakarta_train$harga)),
#         xreg=log1p(data_med_jakarta_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_med_jakarta.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)


forecast_med_jakarta.TF <-
  forecast::forecast(fit_beras_med_jakarta.TF,
                     xreg = ts(log1p(data_med_jakarta_test$RR)))

(postTest_beras_med_jakarta.TF <- 
caret::postResample(data_med_jakarta_test$harga,forecast_med_jakarta.TF$mean))

MAPE(forecast_med_jakarta.TF$mean,data_med_jakarta_test$harga)

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_med_jakarta_test[,"tanggal"],
      y = as.numeric(data_med_jakarta_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_jakarta_test[,"tanggal"],
      y = as.numeric(forecast_med_jakarta.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Jakarta")


#Check QQ-norm
# archres_med_jakarta <- fit_beras_med_jakarta.TF$residuals/fit_beras_med_jakarta.garch@fitted
# qqnorm(archres_med_jakarta)
# qqline(archres_med_jakarta)

```


```{r SVR}
model_temp <- ARml(ts(data_med_jakarta_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_med_jakarta_train$RR), order.by=data_med_jakarta_train$tanggal))


plot(model_temp$model)


fit_beras_med_jakarta.SVR <- ARml(ts(data_med_jakarta_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(150,120,100,80,60),
  sigma=c(0.0001,0.0005, 0.001, 0.002, 0.005)
),xreg=xts(log1p(data_med_jakarta_train$RR), order.by=data_med_jakarta_train$tanggal))

plot(fit_beras_med_jakarta.SVR$model)

#Fitting sigma = 0.002, C = 60

```




```{r forecast}
forecast_med_jakarta.TF <-
  forecast::forecast(fit_beras_med_jakarta.TF,
                     xreg = ts(log1p(data_med_jakarta_test$RR)))


forecast_med_jakarta.SVR <- caretForecast::forecast(fit_beras_med_jakarta.SVR, level = NULL, xreg = xts(log1p(data_med_jakarta_test$RR), order.by = data_med_jakarta_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_med_jakarta.TF) + ylab("harga") +
    autolayer(ts(data_med_jakarta$harga),series="Real data"),
  autoplot(forecast_med_jakarta.SVR) + ylab("harga") +
    autolayer(ts(data_med_jakarta$harga),series="Real data")
  ) 



ggplot() +
  geom_line(
    aes(
      x = data_med_jakarta_test$tanggal,
      y = as.numeric(data_med_jakarta_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_jakarta_test$tanggal,
      y = as.numeric(forecast_med_jakarta.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Jakarta")

```

```{r akurasi model}
accuracy(forecast_med_jakarta.TF,data_med_jakarta_test$harga)
accuracy(forecast_med_jakarta.SVR,data_med_jakarta_test$harga)

MAPE(forecast_med_jakarta.TF$mean,data_med_jakarta_test$harga)
MAPE(forecast_med_jakarta.SVR$mean,data_med_jakarta_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
(postFit_beras_med_jakarta.TF <- 
caret::postResample(data_med_jakarta_train$harga,fit_beras_med_jakarta.TF$fitted))

(postFit_beras_med_jakarta.SVR <- 
caret::postResample(data_med_jakarta_train$harga[-c(1:fit_beras_med_jakarta.SVR$max_lag+1)],na.omit(fit_beras_med_jakarta.SVR$fitted)))

postFit_beras_med_jakarta <-
  matrix(c(postFit_beras_med_jakarta.TF["RMSE"],
                postFit_beras_med_jakarta.TF["MAE"],
                postFit_beras_med_jakarta.TF["Rsquared"],
                postFit_beras_med_jakarta.SVR["RMSE"],
                postFit_beras_med_jakarta.SVR["MAE"],
                postFit_beras_med_jakarta.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_med_jakarta) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_med_jakarta) <- c('ARIMAX','SVR')
postFit_beras_med_jakarta <- round(as.table(postFit_beras_med_jakarta),4)

###Hasil Error data Test
postTest_beras_med_jakarta.TF <- 
caret::postResample(data_med_jakarta_test$harga,forecast_med_jakarta.TF$mean)

(postTest_beras_med_jakarta.SVR <- 
caret::postResample(data_med_jakarta_test$harga,forecast_med_jakarta.SVR$mean))

postTest_beras_med_jakarta <-
  matrix(c(postTest_beras_med_jakarta.TF["RMSE"],
                postTest_beras_med_jakarta.TF["MAE"],
                postTest_beras_med_jakarta.TF["Rsquared"],
                postTest_beras_med_jakarta.SVR["RMSE"],
                postTest_beras_med_jakarta.SVR["MAE"],
                postTest_beras_med_jakarta.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_med_jakarta) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_med_jakarta) <- c('ARIMAX','SVR')
postTest_beras_med_jakarta <- round(as.table(postTest_beras_med_jakarta),4)

paste0("Model Fitting Error")
postFit_beras_med_jakarta
paste0("Model Testing Error")
postTest_beras_med_jakarta

# plot(beras_med_jakarta.m1$x,col="red") +
# lines(fitted(beras_med_jakarta.m1),col="blue")
# 
# plot(fit_beras_med_jakarta.lm$x,col="red") +
# lines(fitted(fit_beras_med_jakarta.lm),col="blue")


```


###Jakarta - High
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_high_jakarta_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_high_jakarta.lm <- lm(log(harga) ~ log1p(RR), data=data_high_jakarta_train)

coeftest(fit_beras_high_jakarta.lm)
summary(fit_beras_high_jakarta.lm)
# auto.arima(data_high_jakarta_train[,"harga"], xreg = log1p(data_high_jakarta_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_high_jakarta.lm$residuals)
auto.arima(fit_beras_high_jakarta.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_high_jakarta.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_high_jakarta.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_high_jakarta.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_high_jakarta.lm$residuals),1), ma.max=7) 

temp.model <- list(c(1,1,0),c(0,1,1),c(1,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_high_jakarta.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,1)



#model arima
res_beras_high_jakarta.m1 <- 
  Arima(fit_beras_high_jakarta.lm$residuals, 
        order=c(0,1,1))
summary(res_beras_high_jakarta.m1)
coeftest(res_beras_high_jakarta.m1)
checkresiduals(res_beras_high_jakarta.m1)
shapiro.test(res_beras_high_jakarta.m1$residuals)
#white noise

Arima(ts(data_high_jakarta_train$harga),
      order = c(0,1,1),
      xreg = ts(log1p(data_high_jakarta_train$RR)),
      lambda = 0)

```
```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_high_jakarta <- 
  prewhiten(x=data_high_jakarta_train$harga,
            y=data_high_jakarta_train$RR)
ccf_high_jakarta$ccf 

# CCF tidak ada yang signifikan, maka tidak dimodelkan fungsi transfer
xlag_high_jakarta <- Lag(ts(log1p(data_high_jakarta_train[,"RR"])),0)
xlag_high_jakarta[is.na(xlag_high_jakarta)]=0
fit_beras_high_jakarta.TFX_temp <-
  arimax(ts(log(data_high_jakarta_train[,"harga"])),
         order=c(0,1,1),
         xtransf = xlag_high_jakarta, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_high_jakarta.TFX_temp)

fit_beras_high_jakarta.TF <- 
  Arima(data_high_jakarta_train$harga,
        xreg = log1p(data_high_jakarta_train$RR),
        lambda = 0,
        order=c(1,1,1))

checkresiduals(fit_beras_high_jakarta.TF)
shapiro.test(fit_beras_high_jakarta.TF$residuals)
autoplot(fit_beras_high_jakarta.TF)
summary(fit_beras_high_jakarta.TF)
coeftest(fit_beras_high_jakarta.TF)

```

```{r ARIMAX, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_high_jakarta_train$harga)),
#         xreg=log1p(data_high_jakarta_train$RR),
#         order=c(1,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_high_jakarta.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)

forecast_high_jakarta.TF <-
  forecast::forecast(fit_beras_high_jakarta.TF,
                     xreg = ts(log1p(data_high_jakarta_test$RR)))

#accuracy
MAPE(forecast_high_jakarta.TF$mean,data_high_jakarta_test$harga)
(postTest_beras_high_jakarta.SVR <- 
caret::postResample(data_high_jakarta_test$harga,forecast_high_jakarta.SVR$mean))

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_high_jakarta_test[,"tanggal"],
      y = as.numeric(data_high_jakarta_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_jakarta_test[,"tanggal"],
      y = as.numeric(forecast_high_jakarta.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Premium Quailty Rice Price Jakarta")


#Check QQ-norm
# archres_high_jakarta <- fit_beras_high_jakarta.TF$residuals/fit_beras_high_jakarta.garch@fitted
# qqnorm(archres_high_jakarta)
# qqline(archres_high_jakarta)

```

```{r SVR}
model_temp <- ARml(ts(data_high_jakarta_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_high_jakarta_train$RR), order.by=data_high_jakarta_train$tanggal))


plot(model_temp$model)


fit_beras_high_jakarta.SVR <- ARml(ts(data_high_jakarta_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(5,10,20,30,50),
  sigma=c(1,5, 10, 15,30)
),xreg=xts(log1p(data_high_jakarta_train$RR), order.by=data_high_jakarta_train$tanggal))

plot(fit_beras_high_jakarta.SVR$model)

#Fitting sigma = 15, C = 10

```




```{r forecast}
forecast_high_jakarta.TF <-
  forecast::forecast(fit_beras_high_jakarta.TF,
                     xreg = ts(log1p(data_high_jakarta_test$RR)))


forecast_high_jakarta.SVR <- caretForecast::forecast(fit_beras_high_jakarta.SVR, level = NULL, xreg = xts(log1p(data_high_jakarta_test$RR), order.by = data_high_jakarta_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_high_jakarta.TF) + ylab("harga") +
    autolayer(ts(data_high_jakarta$harga),series="Real data"),
  autoplot(forecast_high_jakarta.SVR) + ylab("harga") +
    autolayer(ts(data_high_jakarta$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_high_jakarta_test$tanggal,
      y = as.numeric(data_high_jakarta_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_jakarta_test$tanggal,
      y = as.numeric(forecast_high_jakarta.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted High Quailty Rice Price Jakarta")

```


```{r akurasi model}
accuracy(forecast_high_jakarta.TF,data_high_jakarta_test$harga)
accuracy(forecast_high_jakarta.SVR,data_high_jakarta_test$harga)

MAPE(forecast_high_jakarta.TF$mean,data_high_jakarta_test$harga)
MAPE(forecast_high_jakarta.SVR$mean,data_high_jakarta_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_high_jakarta.TF <- 
caret::postResample(data_high_jakarta_train$harga,fit_beras_high_jakarta.TF$fitted)

(postFit_beras_high_jakarta.SVR <- 
caret::postResample(data_high_jakarta_train$harga[-c(1:fit_beras_high_jakarta.SVR$max_lag+1)],na.omit(fit_beras_high_jakarta.SVR$fitted)))

postFit_beras_high_jakarta <-
  matrix(c(postFit_beras_high_jakarta.TF["RMSE"],
                postFit_beras_high_jakarta.TF["MAE"],
                postFit_beras_high_jakarta.TF["Rsquared"],
                postFit_beras_high_jakarta.SVR["RMSE"],
                postFit_beras_high_jakarta.SVR["MAE"],
                postFit_beras_high_jakarta.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_high_jakarta) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_high_jakarta) <- c('ARIMAX','SVR')
postFit_beras_high_jakarta <- round(as.table(postFit_beras_high_jakarta),4)

###Hasil Error data Test
(postTest_beras_high_jakarta.TF <- 
caret::postResample(data_high_jakarta_test$harga,forecast_high_jakarta.TF$mean))

(postTest_beras_high_jakarta.SVR <- 
caret::postResample(data_high_jakarta_test$harga,forecast_high_jakarta.SVR$mean))

postTest_beras_high_jakarta <-
  matrix(c(postTest_beras_high_jakarta.TF["RMSE"],
                postTest_beras_high_jakarta.TF["MAE"],
                postTest_beras_high_jakarta.TF["Rsquared"],
                postTest_beras_high_jakarta.SVR["RMSE"],
                postTest_beras_high_jakarta.SVR["MAE"],
                postTest_beras_high_jakarta.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_high_jakarta) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_high_jakarta) <- c('ARIMAX','SVR')
postTest_beras_high_jakarta <- round(as.table(postTest_beras_high_jakarta),4)

paste0("Model Fitting Error")
postFit_beras_high_jakarta
paste0("Model Testing Error")
postTest_beras_high_jakarta

# plot(beras_high_jakarta.m1$x,col="red") +
# lines(fitted(beras_high_jakarta.m1),col="blue")
# 
# plot(fit_beras_high_jakarta.lm$x,col="red") +
# lines(fitted(fit_beras_high_jakarta.lm),col="blue")


```

## Bandung  

```{r pre-processing data}
data_beras_bandung_kosambi <- subset(data_beras_jawa, 
                            kota == "Bandung" & pasar == "Pasar Kosambi")

data_beras_bandung_kiara_condong <- subset(data_beras_jawa, 
                            kota == "Bandung" & pasar == "Pasar Kiara Condong")

#bagi menjadi 3 kualitas
beras_low_bandung_kosambi <- subset(data_beras_bandung_kosambi, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_bandung_kosambi <- subset(data_beras_bandung_kosambi, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_bandung_kosambi <- subset(data_beras_bandung_kosambi, 
                            komoditas == 'Beras Kualitas Super I (kg)')

beras_low_bandung_kiara_condong <- subset(data_beras_bandung_kiara_condong, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_bandung_kiara_condong <- subset(data_beras_bandung_kiara_condong, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_bandung_kiara_condong <- subset(data_beras_bandung_kiara_condong, 
                            komoditas == 'Beras Kualitas Super I (kg)')



#impute data
beras_low_bandung_kosambi$harga <- na_interpolation(beras_low_bandung_kosambi$harga)
beras_med_bandung_kosambi$harga <- na_interpolation(beras_med_bandung_kosambi$harga)
beras_high_bandung_kosambi$harga <- na_interpolation(beras_high_bandung_kosambi$harga)

beras_low_bandung_kiara_condong$harga <- na_interpolation(beras_low_bandung_kiara_condong$harga)
beras_med_bandung_kiara_condong$harga <- na_interpolation(beras_med_bandung_kiara_condong$harga)
beras_high_bandung_kiara_condong$harga <- na_interpolation(beras_high_bandung_kiara_condong$harga)

#gabung semua pasar terhadap kualitasnya
##LOW - BANDUNG
beras_low_bandung <- merge(x=beras_low_bandung_kosambi,
                          y=dplyr::select(beras_low_bandung_kiara_condong,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_low_bandung <- merge(x=dplyr::select(beras_low_bandung,tanggal,yearweeknum,harga),
                     y=data_klimatologi_bandung_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)

##MED - BANDUNG
beras_med_bandung <- merge(x=beras_med_bandung_kosambi,
                          y=dplyr::select(beras_med_bandung_kiara_condong,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_med_bandung <- merge(x=dplyr::select(beras_med_bandung,tanggal,yearweeknum,harga),
                     y=data_klimatologi_bandung_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)

##HIGH - BANDUNG
beras_high_bandung <- merge(x=beras_high_bandung_kosambi,
                          y=dplyr::select(beras_high_bandung_kiara_condong,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_high_bandung <- merge(x=dplyr::select(beras_high_bandung,tanggal,yearweeknum,harga),
                     y=data_klimatologi_bandung_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)


#bagi data ke dalam train dan fit
data_low_bandung_train <- data_low_bandung[seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_bandung))),]
data_low_bandung_test <- data_low_bandung[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_bandung))),]

data_med_bandung_train <- data_med_bandung[seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_bandung))),]
data_med_bandung_test <- data_med_bandung[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_bandung))),]

data_high_bandung_train <- data_high_bandung[seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_bandung))),]
data_high_bandung_test <- data_high_bandung[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_bandung))),]

```



```{r ploting data harga, warning=FALSE}

gridExtra::grid.arrange(
  autoplot(xts(data_low_bandung$harga, order.by = data_low_bandung$tanggal)) + xlab("") + ylab("harga") + ggtitle("Kualitas Rendah"),
  autoplot(xts(data_med_bandung$harga, order.by = data_med_bandung$tanggal)) + ggtitle("Kualitas Medium") + xlab("") + ylab("harga"),
  autoplot(xts(data_high_bandung$harga, order.by = data_high_bandung$tanggal)) + ggtitle("Kualitas Premium") + xlab("tanggal") + ylab("harga"),
  top = "Harga Beras Yogyakarta"
  ) 

```

###Bandung - Low
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_low_bandung_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_low_bandung.lm <- lm(log(harga) ~ log1p(RR), data=data_low_bandung_train)

coeftest(fit_beras_low_bandung.lm)
summary(fit_beras_low_bandung.lm)
# auto.arima(data_low_bandung_train[,"harga"], xreg = log1p(data_low_bandung_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_low_bandung.lm$residuals)
auto.arima(fit_beras_low_bandung.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_low_bandung.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_low_bandung.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_low_bandung.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_low_bandung.lm$residuals),1), ma.max=7) 

temp.model <- list(c(0,1,2),c(1,1,2),c(2,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_low_bandung.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,2)



#model arima
res_beras_low_bandung.m1 <- 
  Arima(fit_beras_low_bandung.lm$residuals, 
        order=c(0,1,2))
summary(res_beras_low_bandung.m1)
coeftest(res_beras_low_bandung.m1)
checkresiduals(res_beras_low_bandung.m1)
shapiro.test(res_beras_low_bandung.m1$residuals)
#white noise

Arima(ts(data_low_bandung_train$harga),
      order = c(0,1,2),
      xreg = ts(log1p(data_low_bandung_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_low_bandung <- 
  prewhiten(x=data_low_bandung_train$harga,
            y=data_low_bandung_train$RR)
ccf_low_bandung$ccf 

# CCF tidak ada yang signifikan, maka tidak dimodelkan fungsi transfer
xlag_low_bandung <- Lag(ts(log1p(data_low_bandung_train[,"RR"])),0)
xlag_low_bandung[is.na(xlag_low_bandung)]=0
fit_beras_low_bandung.TFX_temp <-
  arimax(ts(log(data_low_bandung_train[,"harga"])),
         order=c(0,1,2),
         xtransf = xlag_low_bandung, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_low_bandung.TFX_temp)

fit_beras_low_bandung.TF <- 
  Arima(data_low_bandung_train$harga,
        xreg = log1p(data_low_bandung_train$RR),
        lambda = 0,
        order=c(0,1,2))

checkresiduals(fit_beras_low_bandung.TF)
shapiro.test(fit_beras_low_bandung.TF$residuals)
autoplot(fit_beras_low_bandung.TF)
summary(fit_beras_low_bandung.TF)
coeftest(fit_beras_low_bandung.TF)

```

```{r ARIMAX, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_low_bandung_train$harga)),
#         xreg=log1p(data_low_bandung_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_low_bandung.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)
forecast_low_bandung.TF <-
  forecast::forecast(fit_beras_low_bandung.TF,
                     xreg = ts(log1p(data_low_bandung_test$RR)))
MAPE(forecast_low_bandung.TF$mean,data_low_bandung_test$harga)
(postTest_beras_low_bandung.TF <- 
caret::postResample(data_low_bandung_test$harga,forecast_low_bandung.TF$mean))

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_low_bandung_test[,"tanggal"],
      y = as.numeric(data_low_bandung_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_bandung_test[,"tanggal"],
      y = as.numeric(forecast_low_bandung.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price bandung")


# #Check QQ-norm
# archres_low_bandung <- fit_beras_low_bandung.TF$residuals/fit_beras_low_bandung.garch@fitted
# qqnorm(archres_low_bandung)
# qqline(archres_low_bandung)

```




```{r SVR}
model_temp <- ARml(ts(data_low_bandung_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_low_bandung_train$RR), order.by=data_low_bandung_train$tanggal))


plot(model_temp$model)


fit_beras_low_bandung.SVR <- ARml(ts(data_low_bandung_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(5,10,20,30,50),
  sigma=c(0.01, 0.005, 0.05, 0.025, 0.0025)
),xreg=xts(log1p(data_low_bandung_train$RR), order.by=data_low_bandung_train$tanggal))

plot(fit_beras_low_bandung.SVR$model)

#Fitting sigma = 15, C = 10

```




```{r forecast}
forecast_low_bandung.TF <-
  forecast::forecast(fit_beras_low_bandung.TF,
                     xreg = ts(log1p(data_low_bandung_test$RR)))


forecast_low_bandung.SVR <- caretForecast::forecast(fit_beras_low_bandung.SVR, level = NULL, xreg = xts(log1p(data_low_bandung_test$RR), order.by = data_low_bandung_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_low_bandung.TF) + ylab("harga") +
    autolayer(ts(data_low_bandung$harga),series="Real data"),
  autoplot(forecast_low_bandung.SVR) + ylab("harga") +
    autolayer(ts(data_low_bandung$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_low_bandung_test$tanggal,
      y = as.numeric(data_low_bandung_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_bandung_test$tanggal,
      y = as.numeric(forecast_low_bandung.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price bandung")

```

```{r akurasi model}
accuracy(forecast_low_bandung.TF,data_low_bandung_test$harga)
accuracy(forecast_low_bandung.SVR,data_low_bandung_test$harga)

MAPE(forecast_low_bandung.TF$mean,data_low_bandung_test$harga)
MAPE(forecast_low_bandung.SVR$mean,data_low_bandung_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_low_bandung.TF <- 
caret::postResample(data_low_bandung_train$harga,fit_beras_low_bandung.TF$fitted)

(postFit_beras_low_bandung.SVR <- 
caret::postResample(data_low_bandung_train$harga[-c(1:fit_beras_low_bandung.SVR$max_lag+1)],na.omit(fit_beras_low_bandung.SVR$fitted)))

postFit_beras_low_bandung <-
  matrix(c(postFit_beras_low_bandung.TF["RMSE"],
                postFit_beras_low_bandung.TF["MAE"],
                postFit_beras_low_bandung.TF["Rsquared"],
                postFit_beras_low_bandung.SVR["RMSE"],
                postFit_beras_low_bandung.SVR["MAE"],
                postFit_beras_low_bandung.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_low_bandung) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_low_bandung) <- c('ARIMAX','SVR')
postFit_beras_low_bandung <- round(as.table(postFit_beras_low_bandung),4)

###Hasil Error data Test
postTest_beras_low_bandung.TF <- 
caret::postResample(data_low_bandung_test$harga,forecast_low_bandung.TF$mean)

postTest_beras_low_bandung.SVR <- 
caret::postResample(data_low_bandung_test$harga,forecast_low_bandung.SVR$mean)

postTest_beras_low_bandung <-
  matrix(c(postTest_beras_low_bandung.TF["RMSE"],
                postTest_beras_low_bandung.TF["MAE"],
                postTest_beras_low_bandung.TF["Rsquared"],
                postTest_beras_low_bandung.SVR["RMSE"],
                postTest_beras_low_bandung.SVR["MAE"],
                postTest_beras_low_bandung.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_low_bandung) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_low_bandung) <- c('ARIMAX','SVR')
postTest_beras_low_bandung <- round(as.table(postTest_beras_low_bandung),4)

paste0("Model Fitting Error")
postFit_beras_low_bandung
paste0("Model Testing Error")
postTest_beras_low_bandung

# plot(beras_low_bandung.m1$x,col="red") +
# lines(fitted(beras_low_bandung.m1),col="blue")
# 
# plot(fit_beras_low_bandung.lm$x,col="red") +
# lines(fitted(fit_beras_low_bandung.lm),col="blue")


```


###Bandung - Med
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_med_bandung_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_med_bandung.lm <- lm(log(harga) ~ log1p(RR), data=data_med_bandung_train)

coeftest(fit_beras_med_bandung.lm)
summary(fit_beras_med_bandung.lm)
# auto.arima(data_med_bandung_train[,"harga"], xreg = log1p(data_med_bandung_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_med_bandung.lm$residuals)
auto.arima(fit_beras_med_bandung.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_med_bandung.lm$residuals),1))

```

```{r SVR}
model_temp <- ARml(ts(data_med_bandung_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_med_bandung_train$RR), order.by=data_med_bandung_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 1, C = 10

fit_beras_med_bandung.SVR <- ARml(ts(data_med_bandung_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(5,10,20,30,50),
  sigma=c(1,5, 10, 15,30)
),xreg=xts(log1p(data_med_bandung_train$RR), order.by=data_med_bandung_train$tanggal))


#Fitting sigma = 1, C = 20
```




```{r forecast}
forecast_med_bandung.TF <-
  forecast::forecast(fit_beras_med_bandung.TF,
                     xreg = ts(log1p(data_med_bandung_test$RR)))


forecast_med_bandung.SVR <- caretForecast::forecast(fit_beras_med_bandung.SVR, level = NULL, xreg = xts(log1p(data_med_bandung_test$RR), order.by = data_med_bandung_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_med_bandung.TF) + ylab("harga") +
    autolayer(ts(data_med_bandung$harga),series="Real data"),
  autoplot(forecast_med_bandung.SVR) + ylab("harga") +
    autolayer(ts(data_med_bandung$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_med_bandung_test$tanggal,
      y = as.numeric(data_med_bandung_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_bandung_test$tanggal,
      y = as.numeric(forecast_med_bandung.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted med Quailty Rice Price bandung")

```

```{r akurasi model}
accuracy(forecast_med_bandung.TF,data_med_bandung_test$harga)
accuracy(forecast_med_bandung.SVR,data_med_bandung_test$harga)

MAPE(forecast_med_bandung.TF$mean,data_med_bandung_test$harga)
MAPE(forecast_med_bandung.SVR$mean,data_med_bandung_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_med_bandung.TF <- 
caret::postResample(data_med_bandung_train$harga,fit_beras_med_bandung.TF$fitted)

postFit_beras_med_bandung.SVR <- 
caret::postResample(data_med_bandung_train$harga[-c(1:fit_beras_med_bandung.SVR$max_lag+1)],na.omit(fit_beras_med_bandung.SVR$fitted))

postFit_beras_med_bandung <-
  matrix(c(postFit_beras_med_bandung.TF["RMSE"],
                postFit_beras_med_bandung.TF["MAE"],
                postFit_beras_med_bandung.TF["Rsquared"],
                postFit_beras_med_bandung.SVR["RMSE"],
                postFit_beras_med_bandung.SVR["MAE"],
                postFit_beras_med_bandung.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_med_bandung) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_med_bandung) <- c('ARIMAX','SVR')
postFit_beras_med_bandung <- round(as.table(postFit_beras_med_bandung),4)

###Hasil Error data Test
postTest_beras_med_bandung.TF <- 
caret::postResample(data_med_bandung_test$harga,forecast_med_bandung.TF$mean)

(postTest_beras_med_bandung.SVR <- 
caret::postResample(data_med_bandung_test$harga,forecast_med_bandung.SVR$mean))

postTest_beras_med_bandung <-
  matrix(c(postTest_beras_med_bandung.TF["RMSE"],
                postTest_beras_med_bandung.TF["MAE"],
                postTest_beras_med_bandung.TF["Rsquared"],
                postTest_beras_med_bandung.SVR["RMSE"],
                postTest_beras_med_bandung.SVR["MAE"],
                postTest_beras_med_bandung.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_med_bandung) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_med_bandung) <- c('ARIMAX','SVR')
postTest_beras_med_bandung <- round(as.table(postTest_beras_med_bandung),4)

paste0("Model Fitting Error")
postFit_beras_med_bandung
paste0("Model Testing Error")
postTest_beras_med_bandung

# plot(beras_med_bandung.m1$x,col="red") +
# lines(fitted(beras_med_bandung.m1),col="blue")
# 
# plot(fit_beras_med_bandung.lm$x,col="red") +
# lines(fitted(fit_beras_med_bandung.lm),col="blue")


```



###Bandung - High
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_high_bandung_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_high_bandung.lm <- lm(log(harga) ~ log1p(RR), data=data_high_bandung_train)

coeftest(fit_beras_high_bandung.lm)
summary(fit_beras_high_bandung.lm)
# auto.arima(data_high_bandung_train[,"harga"], xreg = log1p(data_high_bandung_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_high_bandung.lm$residuals)
auto.arima(fit_beras_high_bandung.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_high_bandung.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_high_bandung.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_high_bandung.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_high_bandung.lm$residuals),1), ma.max=7) 

temp.model <- list(c(0,1,1),c(1,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_high_bandung.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(1,1,1)



#model arima
res_beras_high_bandung.m1 <- 
  Arima(fit_beras_high_bandung.lm$residuals, 
        order=c(1,1,1))
summary(res_beras_high_bandung.m1)
coeftest(res_beras_high_bandung.m1)
checkresiduals(res_beras_high_bandung.m1)
shapiro.test(res_beras_high_bandung.m1$residuals)
#white noise

Arima(ts(data_high_bandung_train$harga),
      order = c(1,1,1),
      xreg = ts(log1p(data_high_bandung_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_high_bandung <- 
  prewhiten(x=data_high_bandung_train$harga,
            y=data_high_bandung_train$RR)
ccf_high_bandung$ccf 

##Menentukan nilai b,r,s (fungsi transfer)

#dipilih nilai s yang besar, untuk melihat pola dari tes koefisien
xlag_high_bandung <- Lag(ts(log1p(data_high_bandung_train[,"RR"])),0)
xlag_high_bandung[is.na(xlag_high_bandung)]=0
fit_beras_high_bandung.TFX_temp <-
  arimax(ts(data_high_bandung_train$harga),
         order=c(1,1,1),
         xtransf = xlag_high_bandung, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML")
coeftest(fit_beras_high_bandung.TFX_temp)

fit_beras_high_bandung.TF <- 
  Arima(data_high_bandung_train$harga,
        xreg = log1p(data_high_bandung_train$RR),
        lambda = 0,
        order=c(1,1,1))


checkresiduals(fit_beras_high_bandung.TF)
shapiro.test(fit_beras_high_bandung.TF$residuals)
autoplot(fit_beras_high_bandung.TF)
summary(fit_beras_high_bandung.TF)
coeftest(fit_beras_high_bandung.TF)

```

```{r ARIMAX-GARCH, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_high_bandung_train$harga)),
#         xreg=log1p(data_high_bandung_train$RR),
#         order=c(1,1,1)))


arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_high_bandung.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#searching for best garch model
aic.garch <- matrix(0,3,4)
bic.garch <- matrix(0,3,4)
for (i in 1:3) {
  for (j in 0:3) {
    garch.spec = ugarchspec(variance.model = list(garchOrder=c(i,j)), 
                            mean.model = list(armaOrder=c(0,0),include.mean = FALSE),
                            distribution.model = "std")
    garch.fit = ugarchfit(spec=garch.spec, data=na.omit(fit_beras_high_bandung.TF$residuals),
                          solver.control=list(trace = F))
    aic.garch[i,j+1] <- infocriteria(garch.fit)[1]
    bic.garch[i,j+1] <- infocriteria(garch.fit)[2]
  }
}
aic.garch
bic.garch
min(aic.garch) # garch(3,1)

#Pemodelan garch
#uji coba fitting model
fit_beras_high_bandung.garch <- garchFit(formula = ~arma(0,0)+garch(1,1),
         data = na.omit(fit_beras_high_bandung.TF$residuals),
         trace = F, include.mean = F)
summary(fit_beras_high_bandung.garch)
#summary LM Arch Test sudah tidak hetero

stdev_high_bandung <- xts(fit_beras_high_bandung.garch@sigma.t, order.by = data_high_bandung_train$tanggal)

plot(xts(fit_beras_high_bandung.garch@sigma.t, order.by = data_high_bandung_train$tanggal))
predict_garch_high_bandung <- fGarch::predict(fit_beras_high_bandung.garch, n.ahead=5, plot=TRUE, nx=214)

#Forecast
addmean <- predict_garch_high_bandung$meanForecast[1]
addstdev <- predict_garch_high_bandung$standardDeviation[1]
dates2 <- as.Date("2021-09-06")
mean_high_bandung <- xts(addmean, order.by=dates2)
stdev_1 <- xts(addstdev, order.by=dates2)
beras_high_bandung_xts.m0.f <- rbind(na.omit(fit_beras_high_bandung.TF$residuals), mean_high_bandung)
stdev_high_bandung <- rbind(stdev_high_bandung, stdev_1)

fit_beras_high_bandung.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,1), data = beras_high_bandung_xts.m0.f, trace = F)

#Looping predict, karena jika predict terlalu jauh akan menghasilkan nilai yang serupa
for (i in 1:length(data_high_bandung_test$harga)-1){
  dates3 <- dates2+7*i
  meanf <- xts(addmean, order.by=dates3)
  stdevf <- xts(addstdev, order.by=dates3)
  beras_high_bandung_xts.m0.f <- rbind(beras_high_bandung_xts.m0.f, meanf)
  stdev_high_bandung <- rbind(stdev_high_bandung, stdevf)
  
  fit_beras_high_bandung.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,1),
                       data = beras_high_bandung_xts.m0.f,
                       trace = F)
  temp1 <- fGarch::predict(fit_beras_high_bandung.garch.f, n.ahead=1, plot=FALSE, nx=215+i)
  addmean <- temp1$meanForecast
  addstdev <- temp1$standardDeviation
}

forecast_high_bandung.TF <-
  forecast::forecast(fit_beras_high_bandung.TF,
                     xreg = ts(log1p(data_high_bandung_test$RR)))


#ambil data forecast saja
forecast_high_bandung.TF_residual <- exp(beras_high_bandung_xts.m0.f[-c(1:215)])

#buat variabel baru untuk join forecasting

forecast_high_bandung.TF_join <- forecast_high_bandung.TF$mean+forecast_high_bandung.TF_residual

#Forecast ARIMAX-GARCH
autoplot(forecast_high_bandung.TF_join) + ylab("harga") +
    autolayer(ts(data_high_bandung$harga),series="Real data")

accuracy(forecast_high_bandung.TF_join, data_high_bandung_test$harga)

MAPE(forecast_high_bandung.TF_join,data_high_bandung_test$harga)
(postTest_beras_high_bandung.TF <- 
caret::postResample(data_high_bandung_test$harga,forecast_high_bandung.TF_join))

ggplot() +
  geom_line(
    aes(
      x = data_high_bandung_test[,"tanggal"],
      y = as.numeric(data_high_bandung_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_bandung_test[,"tanggal"],
      y = as.numeric(forecast_high_bandung.TF_join),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Premium Quailty Rice Price Bandung")


#Check QQ-norm
# archres_high_bandung <- fit_beras_high_bandung.TF$residuals/fit_beras_high_bandung.garch@fitted
# qqnorm(archres_high_bandung)
# qqline(archres_high_bandung)

```

```{r SVR}
model_temp <- ARml(ts(data_high_bandung_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_high_bandung_train$RR), order.by=data_high_bandung_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.1, C = 10

fit_beras_high_bandung.SVR <- ARml(ts(data_high_bandung_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(5,10,20,30,50),
  sigma=c(0.1,0.05, 0.15, 0.2, 0.03)
),xreg=xts(log1p(data_high_bandung_train$RR), order.by=data_high_bandung_train$tanggal))

plot(fit_beras_high_bandung.SVR$model)
#Fitting sigma = 1, C = 20
```




```{r forecast}
forecast_high_bandung.TF <-
  forecast::forecast(fit_beras_high_bandung.TF,
                     xreg = ts(log1p(data_high_bandung_test$RR)))


forecast_high_bandung.SVR <- caretForecast::forecast(fit_beras_high_bandung.SVR, level = NULL, xreg = xts(log1p(data_high_bandung_test$RR), order.by = data_high_bandung_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_high_bandung.TF) + ylab("harga") +
    autolayer(ts(data_high_bandung$harga),series="Real data"),
  autoplot(forecast_high_bandung.SVR) + ylab("harga") +
    autolayer(ts(data_high_bandung$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_high_bandung_test$tanggal,
      y = as.numeric(data_high_bandung_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_bandung_test$tanggal,
      y = as.numeric(forecast_high_bandung.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted High Quailty Rice Price bandung")

```

```{r akurasi model}
accuracy(forecast_high_bandung.TF,data_high_bandung_test$harga)
accuracy(forecast_high_bandung.SVR,data_high_bandung_test$harga)

MAPE(forecast_high_bandung.TF_join,data_high_bandung_test$harga)
MAPE(forecast_high_bandung.SVR$mean,data_high_bandung_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_high_bandung.TF <- 
caret::postResample(data_high_bandung_train$harga,fit_beras_high_bandung.TF$fitted)

postFit_beras_high_bandung.SVR <- 
caret::postResample(data_high_bandung_train$harga[-c(1:fit_beras_high_bandung.SVR$max_lag+1)],na.omit(fit_beras_high_bandung.SVR$fitted))

postFit_beras_high_bandung <-
  matrix(c(postFit_beras_high_bandung.TF["RMSE"],
                postFit_beras_high_bandung.TF["MAE"],
                postFit_beras_high_bandung.TF["Rsquared"],
                postFit_beras_high_bandung.SVR["RMSE"],
                postFit_beras_high_bandung.SVR["MAE"],
                postFit_beras_high_bandung.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_high_bandung) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_high_bandung) <- c('ARIMAX','SVR')
postFit_beras_high_bandung <- round(as.table(postFit_beras_high_bandung),4)

###Hasil Error data Test
postTest_beras_high_bandung.TF <- 
caret::postResample(data_high_bandung_test$harga,forecast_high_bandung.TF$mean)

(postTest_beras_high_bandung.SVR <- 
caret::postResample(data_high_bandung_test$harga,forecast_high_bandung.SVR$mean))

postTest_beras_high_bandung <-
  matrix(c(postTest_beras_high_bandung.TF["RMSE"],
                postTest_beras_high_bandung.TF["MAE"],
                postTest_beras_high_bandung.TF["Rsquared"],
                postTest_beras_high_bandung.SVR["RMSE"],
                postTest_beras_high_bandung.SVR["MAE"],
                postTest_beras_high_bandung.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_high_bandung) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_high_bandung) <- c('ARIMAX','SVR')
postTest_beras_high_bandung <- round(as.table(postTest_beras_high_bandung),4)

paste0("Model Fitting Error")
postFit_beras_high_bandung
paste0("Model Testing Error")
postTest_beras_high_bandung

# plot(beras_high_bandung.m1$x,col="red") +
# lines(fitted(beras_high_bandung.m1),col="blue")
# 
# plot(fit_beras_high_bandung.lm$x,col="red") +
# lines(fitted(fit_beras_high_bandung.lm),col="blue")


```


## Semarang

```{r pre-processing data}
data_beras_semarang_peterongan <- subset(data_beras_jawa, 
                            kota == "Semarang" & pasar == "Pasar Peterongan")

data_beras_semarang_johar <- subset(data_beras_jawa, 
                            kota == "Semarang" & pasar == "Pasar Johar")

#bagi menjadi 3 kualitas
beras_low_semarang_peterongan <- subset(data_beras_semarang_peterongan, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_semarang_peterongan <- subset(data_beras_semarang_peterongan, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_semarang_peterongan <- subset(data_beras_semarang_peterongan, 
                            komoditas == 'Beras Kualitas Super I (kg)')

beras_low_semarang_johar <- subset(data_beras_semarang_johar, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_semarang_johar <- subset(data_beras_semarang_johar, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_semarang_johar <- subset(data_beras_semarang_johar, 
                            komoditas == 'Beras Kualitas Super I (kg)')



#impute data
beras_low_semarang_peterongan$harga <- na_interpolation(beras_low_semarang_peterongan$harga)
beras_med_semarang_peterongan$harga <- na_interpolation(beras_med_semarang_peterongan$harga)
beras_high_semarang_peterongan$harga <- na_interpolation(beras_high_semarang_peterongan$harga)

beras_low_semarang_johar$harga <- na_interpolation(beras_low_semarang_johar$harga)
beras_med_semarang_johar$harga <- na_interpolation(beras_med_semarang_johar$harga)
beras_high_semarang_johar$harga <- na_interpolation(beras_high_semarang_johar$harga)

#gabung semua pasar terhadap kualitasnya
##LOW - SEMARANG
beras_low_semarang <- merge(x=beras_low_semarang_peterongan,
                          y=dplyr::select(beras_low_semarang_johar,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_low_semarang <- merge(x=dplyr::select(beras_low_semarang,tanggal,yearweeknum,harga),
                     y=data_klimatologi_semarang_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)

##MED - SEMARANG
beras_med_semarang <- merge(x=beras_med_semarang_peterongan,
                          y=dplyr::select(beras_med_semarang_johar,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_med_semarang <- merge(x=dplyr::select(beras_med_semarang,tanggal,yearweeknum,harga),
                     y=data_klimatologi_semarang_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)
##HIGH - SEMARANG
beras_high_semarang <- merge(x=beras_high_semarang_peterongan,
                          y=dplyr::select(beras_high_semarang_johar,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_high_semarang <- merge(x=dplyr::select(beras_high_semarang,tanggal,yearweeknum,harga),
                     y=data_klimatologi_semarang_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)

###DIVIDE to TRAIN and TEST
data_low_semarang_train <- data_low_semarang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_semarang))),]
data_low_semarang_test <- data_low_semarang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_semarang))),]

data_med_semarang_train <- data_med_semarang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_semarang))),]
data_med_semarang_test <- data_med_semarang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_semarang))),]

data_high_semarang_train <- data_high_semarang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_semarang))),]
data_high_semarang_test <- data_high_semarang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_semarang))),]

```

```{r ploting data harga, warning=FALSE}

gridExtra::grid.arrange(
  autoplot(xts(data_low_semarang$harga, order.by = data_low_semarang$tanggal)) + xlab("") + ylab("harga") + ggtitle("Kualitas Rendah"),
  autoplot(xts(data_med_semarang$harga, order.by = data_med_semarang$tanggal)) + ggtitle("Kualitas Medium") + xlab("") + ylab("harga"),
  autoplot(xts(data_high_semarang$harga, order.by = data_high_semarang$tanggal)) + ggtitle("Kualitas Premium") + xlab("tanggal") + ylab("harga"),
  top = "Harga Beras semarang"
  ) 

```


###Semarang - Low
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_low_semarang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_low_semarang.lm <- lm(log(harga) ~ log1p(RR), data=data_low_semarang_train)

coeftest(fit_beras_low_semarang.lm)
summary(fit_beras_low_semarang.lm)
# auto.arima(data_low_semarang_train[,"harga"], xreg = log1p(data_low_semarang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_low_semarang.lm$residuals)
auto.arima(fit_beras_low_semarang.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_low_semarang.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_low_semarang.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_low_semarang.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_low_semarang.lm$residuals),1), ma.max=7) 

temp.model <- list(c(0,1,2),c(1,1,2),c(2,1,2))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_low_semarang.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,2)



#model arima
res_beras_low_semarang.m1 <- 
  Arima(fit_beras_low_semarang.lm$residuals, 
        order=c(0,1,2))
summary(res_beras_low_semarang.m1)
coeftest(res_beras_low_semarang.m1)
checkresiduals(res_beras_low_semarang.m1)
shapiro.test(res_beras_low_semarang.m1$residuals)
#white noise

Arima(ts(data_low_semarang_train$harga),
      order = c(0,1,2),
      xreg = ts(log1p(data_low_semarang_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_low_semarang <- 
  prewhiten(x=data_low_semarang_train$harga,
            y=data_low_semarang_train$RR)
ccf_low_semarang$ccf 

# CCF tidak ada yang signifikan, maka tidak dimodelkan fungsi transfer
xlag_low_semarang <- Lag(ts(log1p(data_low_semarang_train[,"RR"])),0)
xlag_low_semarang[is.na(xlag_low_semarang)]=0
fit_beras_low_semarang.TFX_temp <-
  arimax(ts(log(data_low_semarang_train[,"harga"])),
         order=c(0,1,2),
         xtransf = xlag_low_semarang, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_low_semarang.TFX_temp)

fit_beras_low_semarang.TF <- 
  Arima(data_low_semarang_train$harga,
        xreg = log1p(data_low_semarang_train$RR),
        lambda = 0,
        order=c(0,1,2))

checkresiduals(fit_beras_low_semarang.TF)
shapiro.test(fit_beras_low_semarang.TF$residuals)
autoplot(fit_beras_low_semarang.TF)
summary(fit_beras_low_semarang.TF)
coeftest(fit_beras_low_semarang.TF)

```

```{r ARIMAX, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_low_semarang_train$harga)),
#         xreg=log1p(data_low_semarang_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_low_semarang.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)
forecast_low_semarang.TF <-
  forecast::forecast(fit_beras_low_semarang.TF,
                     xreg = ts(log1p(data_low_semarang_test$RR)))

#accuarcy
MAPE(forecast_low_semarang.TF$mean,data_low_semarang_test$harga)
(postTest_beras_low_semarang.TF <- 
caret::postResample(data_low_semarang_test$harga,forecast_low_semarang.TF$mean))

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_low_semarang_test[,"tanggal"],
      y = as.numeric(data_low_semarang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_semarang_test[,"tanggal"],
      y = as.numeric(forecast_low_semarang.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price semarang")


#Check QQ-norm
# archres_low_semarang <- fit_beras_low_semarang.TF$residuals/fit_beras_low_semarang.garch@fitted
# qqnorm(archres_low_semarang)
# qqline(archres_low_semarang)

```
```{r SVR}
model_temp <- ARml(ts(data_low_semarang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_low_semarang_train$RR), order.by=data_low_semarang_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.001, C = 100

fit_beras_low_semarang.SVR <- ARml(ts(data_low_semarang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(150,120,100,80,60),
  sigma=c(0.0001, 0.0005, 0.001, 0.002, 0.005)
),xreg=xts(log1p(data_low_semarang_train$RR), order.by=data_low_semarang_train$tanggal))

plot(fit_beras_low_semarang.SVR$model)
#Fitting sigma = 0.005, C = 60
```




```{r forecast}

forecast_low_semarang.SVR <- caretForecast::forecast(fit_beras_low_semarang.SVR, level = NULL, xreg = xts(log1p(data_low_semarang_test$RR), order.by = data_low_semarang_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_low_semarang.TF) + ylab("harga") +
    autolayer(ts(data_low_semarang$harga),series="Real data"),
  autoplot(forecast_low_semarang.SVR) + ylab("harga") +
    autolayer(ts(data_low_semarang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_low_semarang_test$tanggal,
      y = as.numeric(data_low_semarang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_semarang_test$tanggal,
      y = as.numeric(forecast_low_semarang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Semarang")

```

```{r akurasi model}
accuracy(forecast_low_semarang.TF,data_low_semarang_test$harga)
accuracy(forecast_low_semarang.SVR,data_low_semarang_test$harga)

MAPE(forecast_low_semarang.TF$mean,data_low_semarang_test$harga)
MAPE(forecast_low_semarang.SVR$mean,data_low_semarang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_low_semarang.TF <- 
caret::postResample(data_low_semarang_train$harga,fit_beras_low_semarang.TF$fitted)

postFit_beras_low_semarang.SVR <- 
caret::postResample(data_low_semarang_train$harga[-c(1:fit_beras_low_semarang.SVR$max_lag+1)],na.omit(fit_beras_low_semarang.SVR$fitted))

postFit_beras_low_semarang <-
  matrix(c(postFit_beras_low_semarang.TF["RMSE"],
                postFit_beras_low_semarang.TF["MAE"],
                postFit_beras_low_semarang.TF["Rsquared"],
                postFit_beras_low_semarang.SVR["RMSE"],
                postFit_beras_low_semarang.SVR["MAE"],
                postFit_beras_low_semarang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_low_semarang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_low_semarang) <- c('ARIMAX','SVR')
postFit_beras_low_semarang <- round(as.table(postFit_beras_low_semarang),4)

###Hasil Error data Test
postTest_beras_low_semarang.TF <- 
caret::postResample(data_low_semarang_test$harga,forecast_low_semarang.TF$mean)

(postTest_beras_low_semarang.SVR <- 
caret::postResample(data_low_semarang_test$harga,forecast_low_semarang.SVR$mean))

postTest_beras_low_semarang <-
  matrix(c(postTest_beras_low_semarang.TF["RMSE"],
                postTest_beras_low_semarang.TF["MAE"],
                postTest_beras_low_semarang.TF["Rsquared"],
                postTest_beras_low_semarang.SVR["RMSE"],
                postTest_beras_low_semarang.SVR["MAE"],
                postTest_beras_low_semarang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_low_semarang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_low_semarang) <- c('ARIMAX','SVR')
postTest_beras_low_semarang <- round(as.table(postTest_beras_low_semarang),4)

paste0("Model Fitting Error")
postFit_beras_low_semarang
paste0("Model Testing Error")
postTest_beras_low_semarang

# plot(beras_low_semarang.m1$x,col="red") +
# lines(fitted(beras_low_semarang.m1),col="blue")
# 
# plot(fit_beras_low_semarang.lm$x,col="red") +
# lines(fitted(fit_beras_low_semarang.lm),col="blue")


```


###Semarang - Med
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_med_semarang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_med_semarang.lm <- lm(log(harga) ~ log1p(RR), data=data_med_semarang_train)

coeftest(fit_beras_med_semarang.lm)
summary(fit_beras_med_semarang.lm)
# auto.arima(data_med_semarang_train[,"harga"], xreg = log1p(data_med_semarang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_med_semarang.lm$residuals)
auto.arima(fit_beras_med_semarang.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_med_semarang.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_med_semarang.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_med_semarang.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_med_semarang.lm$residuals),1), ma.max=7) 

temp.model <- list(c(2,1,1),c(2,1,2),c(1,1,0))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_med_semarang.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,2)



#model arima
res_beras_med_semarang.m1 <- 
  Arima(fit_beras_med_semarang.lm$residuals, 
        order=c(1,1,0))
summary(res_beras_med_semarang.m1)
coeftest(res_beras_med_semarang.m1)
checkresiduals(res_beras_med_semarang.m1)
shapiro.test(res_beras_med_semarang.m1$residuals)
#white noise

Arima(ts(data_med_semarang_train$harga),
      order = c(1,1,0),
      xreg = ts(log1p(data_med_semarang_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_med_semarang <- 
  prewhiten(x=data_med_semarang_train$harga,
            y=data_med_semarang_train$RR)
ccf_med_semarang$ccf 

# CCF tidak ada yang signifikan, maka tidak dimodelkan fungsi transfer
xlag_med_semarang <- Lag(ts(log1p(data_med_semarang_train[,"RR"])),0)
xlag_med_semarang[is.na(xlag_med_semarang)]=0
fit_beras_med_semarang.TFX_temp <-
  arimax(ts(log(data_med_semarang_train[,"harga"])),
         order=c(1,1,0),
         xtransf = xlag_med_semarang, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_med_semarang.TFX_temp)

fit_beras_med_semarang.TF <- 
  Arima(data_med_semarang_train$harga,
        xreg = log1p(data_med_semarang_train$RR),
        lambda = 0,
        order=c(1,1,0))

checkresiduals(fit_beras_med_semarang.TF)
shapiro.test(fit_beras_med_semarang.TF$residuals)
autoplot(fit_beras_med_semarang.TF)
summary(fit_beras_med_semarang.TF)
coeftest(fit_beras_med_semarang.TF)

```

```{r ARIMAX-GARCH, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_med_semarang_train$harga)),
#         xreg=log1p(data_med_semarang_train$RR),
#         order=c(1,1,1)))


arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_med_semarang.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#searching for best garch model
aic.garch <- matrix(0,3,4)
bic.garch <- matrix(0,3,4)
for (i in 1:3) {
  for (j in 0:3) {
    garch.spec = ugarchspec(variance.model = list(garchOrder=c(i,j)), 
                            mean.model = list(armaOrder=c(0,0),include.mean = FALSE),
                            distribution.model = "std")
    garch.fit = ugarchfit(spec=garch.spec, data=na.omit(fit_beras_med_semarang.TF$residuals),
                          solver.control=list(trace = F))
    aic.garch[i,j+1] <- infocriteria(garch.fit)[1]
    bic.garch[i,j+1] <- infocriteria(garch.fit)[2]
  }
}
aic.garch
bic.garch
min(aic.garch) # garch(3,1)

#Pemodelan garch
#uji coba fitting model
fit_beras_med_semarang.garch <- garchFit(formula = ~arma(0,0)+garch(1,0),
         data = na.omit(fit_beras_med_semarang.TF$residuals),
         trace = F, include.mean = F)
summary(fit_beras_med_semarang.garch)
#summary LM Arch Test sudah tidak hetero

stdev_med_semarang <- xts(fit_beras_med_semarang.garch@sigma.t, order.by = data_med_semarang_train$tanggal)

plot(xts(fit_beras_med_semarang.garch@sigma.t, order.by = data_med_semarang_train$tanggal))
predict_garch_med_semarang <- fGarch::predict(fit_beras_med_semarang.garch, n.ahead=5, plot=TRUE, nx=214)

#Forecast
addmean <- predict_garch_med_semarang$meanForecast[1]
addstdev <- predict_garch_med_semarang$standardDeviation[1]
dates2 <- as.Date("2021-09-06")
mean_med_semarang <- xts(addmean, order.by=dates2)
stdev_1 <- xts(addstdev, order.by=dates2)
beras_med_semarang_xts.m0.f <- rbind(na.omit(fit_beras_med_semarang.TF$residuals), mean_med_semarang)
stdev_med_semarang <- rbind(stdev_med_semarang, stdev_1)

fit_beras_med_semarang.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,0), data = beras_med_semarang_xts.m0.f, trace = F)

#Looping predict, karena jika predict terlalu jauh akan menghasilkan nilai yang serupa
for (i in 1:length(data_med_semarang_test$harga)-1){
  dates3 <- dates2+7*i
  meanf <- xts(addmean, order.by=dates3)
  stdevf <- xts(addstdev, order.by=dates3)
  beras_med_semarang_xts.m0.f <- rbind(beras_med_semarang_xts.m0.f, meanf)
  stdev_med_semarang <- rbind(stdev_med_semarang, stdevf)
  
  fit_beras_med_semarang.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,0),
                       data = beras_med_semarang_xts.m0.f,
                       trace = F)
  temp1 <- fGarch::predict(fit_beras_med_semarang.garch.f, n.ahead=1, plot=FALSE, nx=215+i)
  addmean <- temp1$meanForecast
  addstdev <- temp1$standardDeviation
}

#ambil data forecast saja
forecast_med_semarang.TF_residual <- exp(beras_med_semarang_xts.m0.f[-c(1:215)])

#buat variabel baru untuk join forecasting

forecast_med_semarang.TF <-
  forecast::forecast(fit_beras_med_semarang.TF,
                     xreg = ts(log1p(data_med_semarang_test$RR)))

forecast_med_semarang.TF_join <- forecast_med_semarang.TF$mean+forecast_med_semarang.TF_residual

#Forecast ARIMAX-GARCH
autoplot(forecast_med_semarang.TF_join) + ylab("harga") +
    autolayer(ts(data_med_semarang$harga),series="Real data")

accuracy(forecast_med_semarang.TF_join, data_med_semarang_test$harga)

MAPE(forecast_med_semarang.TF_join,data_med_semarang_test$harga)
(postTest_beras_med_semarang.TF <- 
caret::postResample(data_med_semarang_test$harga,forecast_med_semarang.TF_join))

ggplot() +
  geom_line(
    aes(
      x = data_med_semarang_test[,"tanggal"],
      y = as.numeric(data_med_semarang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_semarang_test[,"tanggal"],
      y = as.numeric(forecast_med_semarang.TF_join),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Semarang")


#Check QQ-norm
# archres_med_semarang <- fit_beras_med_semarang.TF$residuals/fit_beras_med_semarang.garch@fitted
# qqnorm(archres_med_semarang)
# qqline(archres_med_semarang)

```

```{r SVR}
model_temp <- ARml(ts(data_med_semarang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_med_semarang_train$RR), order.by=data_med_semarang_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.01, C = 1

fit_beras_med_semarang.SVR <- ARml(ts(data_med_semarang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(0.05,0.1,0.5,1,5),
  sigma=c(0.01, 0.005, 0.05, 0.025, 0.0025)
),xreg=xts(log1p(data_med_semarang_train$RR), order.by=data_med_semarang_train$tanggal))

plot(fit_beras_med_semarang.SVR$model)
#Fitting sigma = 0.01, C = 0.5
```




```{r forecast}
forecast_med_semarang.SVR <- caretForecast::forecast(fit_beras_med_semarang.SVR, level = NULL, xreg = xts(log1p(data_med_semarang_test$RR), order.by = data_med_semarang_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_med_semarang.TF) + ylab("harga") +
    autolayer(ts(data_med_semarang$harga),series="Real data"),
  autoplot(forecast_med_semarang.SVR) + ylab("harga") +
    autolayer(ts(data_med_semarang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_med_semarang_test$tanggal,
      y = as.numeric(data_med_semarang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_semarang_test$tanggal,
      y = as.numeric(forecast_med_semarang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Semarang")

```

```{r akurasi model}
accuracy(forecast_med_semarang.TF,data_med_semarang_test$harga)
accuracy(forecast_med_semarang.SVR,data_med_semarang_test$harga)

MAPE(forecast_med_semarang.TF_join,data_med_semarang_test$harga)
MAPE(forecast_med_semarang.SVR$mean,data_med_semarang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_med_semarang.TF <- 
caret::postResample(data_med_semarang_train$harga,fit_beras_med_semarang.TF$fitted)

postFit_beras_med_semarang.SVR <- 
caret::postResample(data_med_semarang_train$harga[-c(1:fit_beras_med_semarang.SVR$max_lag+1)],na.omit(fit_beras_med_semarang.SVR$fitted))

postFit_beras_med_semarang <-
  matrix(c(postFit_beras_med_semarang.TF["RMSE"],
                postFit_beras_med_semarang.TF["MAE"],
                postFit_beras_med_semarang.TF["Rsquared"],
                postFit_beras_med_semarang.SVR["RMSE"],
                postFit_beras_med_semarang.SVR["MAE"],
                postFit_beras_med_semarang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_med_semarang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_med_semarang) <- c('ARIMAX','SVR')
postFit_beras_med_semarang <- round(as.table(postFit_beras_med_semarang),4)

###Hasil Error data Test
postTest_beras_med_semarang.TF <- 
caret::postResample(data_med_semarang_test$harga,forecast_med_semarang.TF$mean)

(postTest_beras_med_semarang.SVR <- 
caret::postResample(data_med_semarang_test$harga,forecast_med_semarang.SVR$mean))

postTest_beras_med_semarang <-
  matrix(c(postTest_beras_med_semarang.TF["RMSE"],
                postTest_beras_med_semarang.TF["MAE"],
                postTest_beras_med_semarang.TF["Rsquared"],
                postTest_beras_med_semarang.SVR["RMSE"],
                postTest_beras_med_semarang.SVR["MAE"],
                postTest_beras_med_semarang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_med_semarang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_med_semarang) <- c('ARIMAX','SVR')
postTest_beras_med_semarang <- round(as.table(postTest_beras_med_semarang),4)

paste0("Model Fitting Error")
postFit_beras_med_semarang
paste0("Model Testing Error")
postTest_beras_med_semarang

# plot(beras_med_semarang.m1$x,col="red") +
# lines(fitted(beras_med_semarang.m1),col="blue")
# 
# plot(fit_beras_med_semarang.lm$x,col="red") +
# lines(fitted(fit_beras_med_semarang.lm),col="blue")


```


###Semarang - High
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_high_semarang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_high_semarang.lm <- lm(log(harga) ~ log1p(RR), data=data_high_semarang_train)

coeftest(fit_beras_high_semarang.lm)
summary(fit_beras_high_semarang.lm)
# auto.arima(data_high_semarang_train[,"harga"], xreg = log1p(data_high_semarang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_high_semarang.lm$residuals)
auto.arima(fit_beras_high_semarang.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_high_semarang.lm$residuals),1))

#tidak signifikan korelasinya

```



```{r SVR}
model_temp <- ARml(ts(data_high_semarang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_high_semarang_train$RR), order.by=data_high_semarang_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.001, C = 100

fit_beras_high_semarang.SVR <- ARml(ts(data_high_semarang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(150,120,100,80,60),
  sigma=c(0.0001, 0.0005, 0.001, 0.002, 0.005)
),xreg=xts(log1p(data_high_semarang_train$RR), order.by=data_high_semarang_train$tanggal))

plot(fit_beras_high_semarang.SVR$model)
#Fitting sigma = 0.001, C = 120
```



```{r forecast}

forecast_high_semarang.SVR <- caretForecast::forecast(fit_beras_high_semarang.SVR, level = NULL, xreg = xts(log1p(data_high_semarang_test$RR), order.by = data_high_semarang_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_high_semarang.TF) + ylab("harga") +
    autolayer(ts(data_high_semarang$harga),series="Real data"),
  autoplot(forecast_high_semarang.SVR) + ylab("harga") +
    autolayer(ts(data_high_semarang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_high_semarang_test$tanggal,
      y = as.numeric(data_high_semarang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_semarang_test$tanggal,
      y = as.numeric(forecast_high_semarang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted High Quailty Rice Price Semarang")

```

```{r akurasi model}
accuracy(forecast_high_semarang.TF,data_high_semarang_test$harga)
accuracy(forecast_high_semarang.SVR,data_high_semarang_test$harga)

MAPE(forecast_high_semarang.TF$mean,data_high_semarang_test$harga)
MAPE(forecast_high_semarang.SVR$mean,data_high_semarang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_high_semarang.TF <- 
caret::postResample(data_high_semarang_train$harga,fit_beras_high_semarang.TF$fitted)

postFit_beras_high_semarang.SVR <- 
caret::postResample(data_high_semarang_train$harga[-c(1:fit_beras_high_semarang.SVR$max_lag+1)],na.omit(fit_beras_high_semarang.SVR$fitted))

postFit_beras_high_semarang <-
  matrix(c(postFit_beras_high_semarang.TF["RMSE"],
                postFit_beras_high_semarang.TF["MAE"],
                postFit_beras_high_semarang.TF["Rsquared"],
                postFit_beras_high_semarang.SVR["RMSE"],
                postFit_beras_high_semarang.SVR["MAE"],
                postFit_beras_high_semarang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_high_semarang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_high_semarang) <- c('ARIMAX','SVR')
postFit_beras_high_semarang <- round(as.table(postFit_beras_high_semarang),4)

###Hasil Error data Test
postTest_beras_high_semarang.TF <- 
caret::postResample(data_high_semarang_test$harga,forecast_high_semarang.TF$mean)

(postTest_beras_high_semarang.SVR <- 
caret::postResample(data_high_semarang_test$harga,forecast_high_semarang.SVR$mean))

postTest_beras_high_semarang <-
  matrix(c(postTest_beras_high_semarang.TF["RMSE"],
                postTest_beras_high_semarang.TF["MAE"],
                postTest_beras_high_semarang.TF["Rsquared"],
                postTest_beras_high_semarang.SVR["RMSE"],
                postTest_beras_high_semarang.SVR["MAE"],
                postTest_beras_high_semarang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_high_semarang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_high_semarang) <- c('ARIMAX','SVR')
postTest_beras_high_semarang <- round(as.table(postTest_beras_high_semarang),4)

paste0("Model Fitting Error")
postFit_beras_high_semarang
paste0("Model Testing Error")
postTest_beras_high_semarang

# plot(beras_high_semarang.m1$x,col="red") +
# lines(fitted(beras_high_semarang.m1),col="blue")
# 
# plot(fit_beras_high_semarang.lm$x,col="red") +
# lines(fitted(fit_beras_high_semarang.lm),col="blue")


```



## Yogyakarta

```{r pre-processing data}
data_beras_jogja_beringharjo <- subset(data_beras_jawa, 
                            kota == "Yogyakarta" & pasar == "Pasar Beringharjo")

data_beras_jogja_kraggan <- subset(data_beras_jawa, 
                            kota == "Yogyakarta" & pasar == "Pasar Kraggan")

#bagi menjadi 3 kualitas
beras_low_jogja_beringharjo <- subset(data_beras_jogja_beringharjo, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_jogja_beringharjo <- subset(data_beras_jogja_beringharjo, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_jogja_beringharjo <- subset(data_beras_jogja_beringharjo, 
                            komoditas == 'Beras Kualitas Super I (kg)')

beras_low_jogja_kraggan <- subset(data_beras_jogja_kraggan, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_jogja_kraggan <- subset(data_beras_jogja_kraggan, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_jogja_kraggan <- subset(data_beras_jogja_kraggan, 
                            komoditas == 'Beras Kualitas Super I (kg)')



#impute data
beras_low_jogja_beringharjo$harga <- na_interpolation(beras_low_jogja_beringharjo$harga)
beras_med_jogja_beringharjo$harga <- na_interpolation(beras_med_jogja_beringharjo$harga)
beras_high_jogja_beringharjo$harga <- na_interpolation(beras_high_jogja_beringharjo$harga)

beras_low_jogja_kraggan$harga <- na_interpolation(beras_low_jogja_kraggan$harga)
beras_med_jogja_kraggan$harga <- na_interpolation(beras_med_jogja_kraggan$harga)
beras_high_jogja_kraggan$harga <- na_interpolation(beras_high_jogja_kraggan$harga)

#gabung semua pasar terhadap kualitasnya
##LOW - JOGJA
beras_low_jogja <- merge(x=beras_low_jogja_beringharjo,
                          y=dplyr::select(beras_low_jogja_kraggan,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_low_jogja <- merge(x=dplyr::select(beras_low_jogja,tanggal,yearweeknum,harga),
                     y=data_klimatologi_jogja_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>%  arrange(tanggal)

##MED - JOJGA
beras_med_jogja <- merge(x=beras_med_jogja_beringharjo,
                          y=dplyr::select(beras_med_jogja_kraggan,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_med_jogja <- merge(x=dplyr::select(beras_med_jogja,tanggal,yearweeknum,harga),
                     y=data_klimatologi_jogja_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal) %>% arrange(tanggal)

###HIGH-SERANG
beras_high_jogja <- merge(x=beras_high_jogja_beringharjo,
                          y=dplyr::select(beras_high_jogja_kraggan,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_high_jogja <- merge(x=dplyr::select(beras_high_jogja,tanggal,yearweeknum,harga),
                     y=data_klimatologi_jogja_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)


#bagi data ke dalam train dan fit
data_low_jogja_train <- data_low_jogja[seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_jogja))),]
data_low_jogja_test <- data_low_jogja[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_jogja))),]

data_med_jogja_train <- data_med_jogja[seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_jogja))),]
data_med_jogja_test <- data_med_jogja[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_jogja))),]

data_high_jogja_train <- data_high_jogja[seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_jogja))),]
data_high_jogja_test <- data_high_jogja[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_jogja))),]

```



```{r ploting data harga, warning=FALSE}

gridExtra::grid.arrange(
  autoplot(xts(data_low_jogja$harga, order.by = data_low_jogja$tanggal)) + xlab("") + ylab("harga") + ggtitle("Kualitas Rendah"),
  autoplot(xts(data_med_jogja$harga, order.by = data_med_jogja$tanggal)) + ggtitle("Kualitas Medium") + xlab("") + ylab("harga"),
  autoplot(xts(data_high_jogja$harga, order.by = data_high_jogja$tanggal)) + ggtitle("Kualitas Premium") + xlab("tanggal") + ylab("harga"),
  top = "Harga Beras Yogyakarta"
  ) 

```


###Yogyakarta - Low
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_low_jogja_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_low_jogja.lm <- lm(log(harga) ~ log1p(RR), data=data_low_jogja_train)

coeftest(fit_beras_low_jogja.lm)
summary(fit_beras_low_jogja.lm)
# auto.arima(data_low_jogja_train[,"harga"], xreg = log1p(data_low_jogja_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_low_jogja.lm$residuals)
auto.arima(fit_beras_low_jogja.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_low_jogja.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_low_jogja.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_low_jogja.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_low_jogja.lm$residuals),1), ma.max=7) 

temp.model <- list(c(1,1,1),c(1,1,2))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_low_jogja.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,2)

#model arima
res_beras_low_jogja.m1 <- 
  Arima(fit_beras_low_jogja.lm$residuals, 
        order=c(1,1,1))
summary(res_beras_low_jogja.m1)
coeftest(res_beras_low_jogja.m1)
checkresiduals(res_beras_low_jogja.m1)
shapiro.test(res_beras_low_jogja.m1$residuals)
#white noise

Arima(ts(data_low_jogja_train$harga),
      order = c(1,1,1),
      xreg = ts(log1p(data_low_jogja_train$RR)),
      lambda = 0)

```


```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

#Tes CCF
ccf_low_jogja <- 
  prewhiten(x=data_low_jogja_train$harga,
            y=data_low_jogja_train$RR)
ccf_low_jogja$ccf 

# b=15
xlag_low_jogja <- Lag(log1p(data_low_jogja_train[,"RR"]),15)
xlag_low_jogja[is.na(xlag_low_jogja)]=0
fit_beras_low_jogja.TFX_temp <-
  arimax(ts(log(data_low_jogja_train[,"harga"])),
         order=c(1,1,1),
         xtransf = xlag_low_jogja, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 
#Cek signifikansi
coeftest(fit_beras_low_jogja.TFX_temp)


fit_beras_low_jogja.TFX <- 
  arimax(ts(log(data_low_jogja_train[,"harga"])),
         order=c(1,1,1),
         xtransf = xlag_low_jogja,
         transfer = list(c(0,0)),
         include.mean = TRUE,
         method="ML") 

#Filter xreg
beras_low_jogja.tx <- 
  stats::filter(xlag_low_jogja, 
 exp(coef(fit_beras_low_jogja.TFX)[c(3)]),
                method="convolution",
                sides = 1)

```

```{r Fungsi Transfer 2}

fit_beras_low_jogja.TF <- 
  Arima(data_low_jogja_train$harga,
        xreg = beras_low_jogja.tx,
        lambda = 0,
        order=c(1,1,1))

checkresiduals(fit_beras_low_jogja.TF)
shapiro.test(fit_beras_low_jogja.TF$residuals)
autoplot(fit_beras_low_jogja.TF)
summary(fit_beras_low_jogja.TF)
coeftest(fit_beras_low_jogja.TF)

forecast_low_jogja.TF <-
  forecast::forecast(fit_beras_low_jogja.TF,
                     xreg = ts(log1p(data_low_jogja_test$RR)))

```


```{r ARIMAX-GARCH, warning=FALSE}

#ARCH_test
arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_low_jogja.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#searching for best garch model
aic.garch <- matrix(0,3,4)
bic.garch <- matrix(0,3,4)
for (i in 1:3) {
  for (j in 0:3) {
    garch.spec = ugarchspec(variance.model = list(garchOrder=c(i,j)), 
                            mean.model = list(armaOrder=c(0,0),include.mean = FALSE),
                            distribution.model = "std")
    garch.fit = ugarchfit(spec=garch.spec, data=na.omit(fit_beras_low_jogja.TF$residuals),
                          solver.control=list(trace = F), solver="hybrid")
    aic.garch[i,j+1] <- infocriteria(garch.fit)[1]
    bic.garch[i,j+1] <- infocriteria(garch.fit)[2]
  }
}
aic.garch
bic.garch
min(aic.garch) # garch(1,0)


#Pemodelan garch
#uji coba fitting model
fit_beras_low_jogja.garch <- garchFit(formula = ~arma(0,0)+garch(1,0),
         data = na.omit(fit_beras_low_jogja.TF$residuals),
         trace = F, include.mean = F)
summary(fit_beras_low_jogja.garch)
#summary LM Arch Test sudah tidak hetero

stdev_low_jogja <- xts(fit_beras_low_jogja.garch@sigma.t, order.by = data_low_jogja_train$tanggal)

plot(xts(fit_beras_low_jogja.garch@sigma.t, order.by = data_low_jogja_train$tanggal))
predict_garch_low_jogja <- fGarch::predict(fit_beras_low_jogja.garch, n.ahead=5, plot=TRUE, nx=214)

#Forecast
addmean <- predict_garch_low_jogja$meanForecast[1]
addstdev <- predict_garch_low_jogja$standardDeviation[1]
dates2 <- as.Date("2021-09-06")
mean_low_jogja <- xts(addmean, order.by=dates2)
stdev_1 <- xts(addstdev, order.by=dates2)
beras_low_jogja_xts.m0.f <- rbind(na.omit(fit_beras_low_jogja.TF$residuals), mean_low_jogja)
stdev_low_jogja <- rbind(stdev_low_jogja, stdev_1)

fit_beras_low_jogja.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,0), data = beras_low_jogja_xts.m0.f, trace = F)

#Looping predict, karena jika predict terlalu jauh akan menghasilkan nilai yang serupa
for (i in 1:length(data_low_jogja_test$harga)-1){
  dates3 <- dates2+7*i
  meanf <- xts(addmean, order.by=dates3)
  stdevf <- xts(addstdev, order.by=dates3)
  beras_low_jogja_xts.m0.f <- rbind(beras_low_jogja_xts.m0.f, meanf)
  stdev_low_jogja <- rbind(stdev_low_jogja, stdevf)
  
  fit_beras_low_jogja.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,0),
                       data = beras_low_jogja_xts.m0.f,
                       trace = F)
  temp1 <- fGarch::predict(fit_beras_low_jogja.garch.f, n.ahead=1, plot=FALSE, nx=215+i)
  addmean <- temp1$meanForecast
  addstdev <- temp1$standardDeviation
}

#ambil data forecast saja
forecast_low_jogja.TF_residual <- exp(beras_low_jogja_xts.m0.f[-c(1:215)])

#buat variabel baru untuk join forecasting
forecast_low_jogja.TF_join <- forecast_low_jogja.TF$mean+forecast_low_jogja.TF_residual

#Forecast ARIMAX-GARCH
autoplot(forecast_low_jogja.TF_join) + ylab("harga") +
    autolayer(ts(data_low_jogja$harga),series="Real data")

accuracy(forecast_low_jogja.TF_join, data_low_jogja_test$harga)



ggplot() +
  geom_line(
    aes(
      x = data_low_jogja_test[,"tanggal"],
      y = as.numeric(data_low_jogja_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_jogja_test[,"tanggal"],
      y = as.numeric(forecast_low_jogja.TF_join),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Yogyakarta")


#Check QQ-norm
# archres_low_jogja <- fit_beras_low_jogja.TF$residuals/fit_beras_low_jogja.garch@fitted
# qqnorm(archres_low_jogja)
# qqline(archres_low_jogja)

```

```{r SVR}
#COARSE-GRID
model_temp <- ARml(ts(data_low_jogja_train$harga), 
                   maxlag = 12, 
                   caret_method = "svmRadialSigma",
                   lambda = 0, 
                   pre_process = c('center', 'scale'), 
                   tune_grid = expand.grid(C=c(1,10,100,1000),
                                           sigma=c(0.001, 0.01, 0.1,1)),
                   xreg=xts(log1p(data_low_jogja_train$RR),
                            order.by=data_low_jogja_train$tanggal))

plot(model_temp$model)
#Fitting sigma = 0.01, C = 1000


fit_beras_low_jogja.SVR <- ARml(ts(data_low_jogja_train$harga), 
                                maxlag = 12, 
                                caret_method = "svmRadialSigma",
                                lambda = 0, preProcess = "scale",
                                tune_grid = expand.grid(C=c(200,500,700,1000,1200),
                                                        sigma=c(0.0001, 0.0005, 0.001, 0.002, 0.005)),
                                xreg=xts(log1p(data_low_jogja_train$RR),
                                         order.by=data_low_jogja_train$tanggal))

plot(fit_beras_low_jogja.SVR$model)
#Fitting sigma = 0.001, C = 500

get_var_imp(forecast_low_jogja.SVR)
```




```{r forecast}

forecast_low_jogja.SVR <- caretForecast::forecast(fit_beras_low_jogja.SVR, level = NULL, xreg = xts(log1p(data_low_jogja_test$RR), order.by = data_low_jogja_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_low_jogja.TF) + ylab("harga") +
    autolayer(ts(data_low_jogja$harga),series="Real data"),
  autoplot(forecast_low_jogja.SVR) + ylab("harga") +
    autolayer(ts(data_low_jogja$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_low_jogja_test$tanggal,
      y = as.numeric(data_low_jogja_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_jogja_test$tanggal,
      y = as.numeric(forecast_low_jogja.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Yogykarta")

```

```{r akurasi model}
accuracy(forecast_low_jogja.TF,data_low_jogja_test$harga)
accuracy(forecast_low_jogja.SVR,data_low_jogja_test$harga)

MAPE(forecast_low_jogja.TF_join,data_low_jogja_test$harga)
MAPE(forecast_low_jogja.SVR$mean,data_low_jogja_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_low_jogja.TF <- 
caret::postResample(data_low_jogja_train$harga,fit_beras_low_jogja.TF$fitted)

postFit_beras_low_jogja.SVR <- 
caret::postResample(data_low_jogja_train$harga[-c(1:fit_beras_low_jogja.SVR$max_lag+1)],na.omit(fit_beras_low_jogja.SVR$fitted))

postFit_beras_low_jogja <-
  matrix(c(postFit_beras_low_jogja.TF["RMSE"],
                postFit_beras_low_jogja.TF["MAE"],
                postFit_beras_low_jogja.TF["Rsquared"],
                postFit_beras_low_jogja.SVR["RMSE"],
                postFit_beras_low_jogja.SVR["MAE"],
                postFit_beras_low_jogja.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_low_jogja) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_low_jogja) <- c('ARIMAX','SVR')
postFit_beras_low_jogja <- round(as.table(postFit_beras_low_jogja),4)

###Hasil Error data Test
(postTest_beras_low_jogja.TF <- 
caret::postResample(data_low_jogja_test$harga,forecast_low_jogja.TF_join))

(postTest_beras_low_jogja.SVR <- 
caret::postResample(data_low_jogja_test$harga,forecast_low_jogja.SVR$mean))

postTest_beras_low_jogja <-
  matrix(c(postTest_beras_low_jogja.TF["RMSE"],
                postTest_beras_low_jogja.TF["MAE"],
                postTest_beras_low_jogja.TF["Rsquared"],
                postTest_beras_low_jogja.SVR["RMSE"],
                postTest_beras_low_jogja.SVR["MAE"],
                postTest_beras_low_jogja.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_low_jogja) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_low_jogja) <- c('ARIMAX','SVR')
postTest_beras_low_jogja <- round(as.table(postTest_beras_low_jogja),4)

paste0("Model Fitting Error")
postFit_beras_low_jogja
paste0("Model Testing Error")
postTest_beras_low_jogja

# plot(beras_low_jogja.m1$x,col="red") +
# lines(fitted(beras_low_jogja.m1),col="blue")
# 
# plot(fit_beras_low_jogja.lm$x,col="red") +
# lines(fitted(fit_beras_low_jogja.lm),col="blue")


```


###Yogyakarta - Med

```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_med_jogja_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_med_jogja.lm <- lm(log(harga) ~ log1p(RR), data=data_med_jogja_train)

coeftest(fit_beras_med_jogja.lm)
summary(fit_beras_med_jogja.lm)
# auto.arima(data_med_jogja_train[,"harga"], xreg = log1p(data_med_jogja_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_med_jogja.lm$residuals)
auto.arima(fit_beras_med_jogja.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_med_jogja.lm$residuals),1))

```



```{r SVR}
model_temp <- ARml(ts(data_med_jogja_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_med_jogja_train$RR), order.by=data_med_jogja_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.01, C = 1

fit_beras_med_jogja.SVR <- ARml(ts(data_med_jogja_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(0.05,0.1,0.5,1,5),
  sigma=c(0.01, 0.005, 0.05, 0.025, 0.0025)
),xreg=xts(log1p(data_med_jogja_train$RR), order.by=data_med_jogja_train$tanggal))

plot(fit_beras_med_jogja.SVR$model)
#Fitting sigma = 0.025, C = 1
```




```{r forecast}
forecast_med_jogja.TF <-
  forecast::forecast(fit_beras_med_jogja.TF,
                     xreg = ts(log1p(data_med_jogja_test$RR)))


forecast_med_jogja.SVR <- caretForecast::forecast(fit_beras_med_jogja.SVR, level = NULL, xreg = xts(log1p(data_med_jogja_test$RR), order.by = data_med_jogja_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_med_jogja.TF) + ylab("harga") +
    autolayer(ts(data_med_jogja$harga),series="Real data"),
  autoplot(forecast_med_jogja.SVR) + ylab("harga") +
    autolayer(ts(data_med_jogja$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_med_jogja_test$tanggal,
      y = as.numeric(data_med_jogja_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_jogja_test$tanggal,
      y = as.numeric(forecast_med_jogja.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Yogykarta")

```

```{r akurasi model}
accuracy(forecast_med_jogja.TF,data_med_jogja_test$harga)
accuracy(forecast_med_jogja.SVR,data_med_jogja_test$harga)

MAPE(forecast_med_jogja.TF$mean,data_med_jogja_test$harga)
MAPE(forecast_med_jogja.SVR$mean,data_med_jogja_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_med_jogja.TF <- 
caret::postResample(data_med_jogja_train$harga,fit_beras_med_jogja.TF$fitted)

postFit_beras_med_jogja.SVR <- 
caret::postResample(data_med_jogja_train$harga[-c(1:fit_beras_med_jogja.SVR$max_lag+1)],na.omit(fit_beras_med_jogja.SVR$fitted))

postFit_beras_med_jogja <-
  matrix(c(postFit_beras_med_jogja.TF["RMSE"],
                postFit_beras_med_jogja.TF["MAE"],
                postFit_beras_med_jogja.TF["Rsquared"],
                postFit_beras_med_jogja.SVR["RMSE"],
                postFit_beras_med_jogja.SVR["MAE"],
                postFit_beras_med_jogja.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_med_jogja) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_med_jogja) <- c('ARIMAX','SVR')
postFit_beras_med_jogja <- round(as.table(postFit_beras_med_jogja),4)

###Hasil Error data Test
postTest_beras_med_jogja.TF <- 
caret::postResample(data_med_jogja_test$harga,forecast_med_jogja.TF$mean)

(postTest_beras_med_jogja.SVR <- 
caret::postResample(data_med_jogja_test$harga,forecast_med_jogja.SVR$mean))

postTest_beras_med_jogja <-
  matrix(c(postTest_beras_med_jogja.TF["RMSE"],
                postTest_beras_med_jogja.TF["MAE"],
                postTest_beras_med_jogja.TF["Rsquared"],
                postTest_beras_med_jogja.SVR["RMSE"],
                postTest_beras_med_jogja.SVR["MAE"],
                postTest_beras_med_jogja.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_med_jogja) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_med_jogja) <- c('ARIMAX','SVR')
postTest_beras_med_jogja <- round(as.table(postTest_beras_med_jogja),4)

paste0("Model Fitting Error")
postFit_beras_med_jogja
paste0("Model Testing Error")
postTest_beras_med_jogja

# plot(beras_med_jogja.m1$x,col="red") +
# lines(fitted(beras_med_jogja.m1),col="blue")
# 
# plot(fit_beras_med_jogja.lm$x,col="red") +
# lines(fitted(fit_beras_med_jogja.lm),col="blue")


```



###Yogyakarta - High
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_high_jogja_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_high_jogja.lm <- lm(log(harga) ~ log1p(RR), data=data_high_jogja_train)

coeftest(fit_beras_high_jogja.lm)
summary(fit_beras_high_jogja.lm)
# auto.arima(data_high_jogja_train[,"harga"], xreg = log1p(data_high_jogja_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_high_jogja.lm$residuals)
auto.arima(fit_beras_high_jogja.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_high_jogja.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_high_jogja.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_high_jogja.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_high_jogja.lm$residuals),1), ma.max=7) 

temp.model <- list(c(1,1,1),c(1,1,0),c(0,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_high_jogja.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,2)



#model arima
res_beras_high_jogja.m1 <- 
  Arima(fit_beras_high_jogja.lm$residuals, 
        order=c(0,1,2))
summary(res_beras_high_jogja.m1)
coeftest(res_beras_high_jogja.m1)
checkresiduals(res_beras_high_jogja.m1)
shapiro.test(res_beras_high_jogja.m1$residuals)
#white noise

Arima(ts(data_high_jogja_train$harga),
      order = c(1,1,1),
      xreg = ts(log1p(data_high_jogja_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_high_jogja <- 
  prewhiten(x=data_high_jogja_train$harga,
            y=data_high_jogja_train$RR)
ccf_high_jogja$ccf 

# b=15
xlag_high_jogja <- Lag(log1p(data_high_jogja_train[,"RR"]),15)
xlag_high_jogja[is.na(xlag_high_jogja)]=0
fit_beras_high_jogja.TFX_temp <-
  arimax(ts(log(data_high_jogja_train[,"harga"])),
         order=c(1,1,1),
         xtransf = xlag_high_jogja, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_high_jogja.TFX_temp)

fit_beras_high_jogja.TFX <- 
  arimax(ts(log(data_high_jogja_train[,"harga"])),
         order=c(1,1,1),
         xtransf = xlag_high_jogja,
         transfer = list(c(0,0)),
         include.mean = TRUE,
         method="ML") 

coef(fit_beras_high_jogja.TFX)
fit_beras_high_jogja.TFX$model



beras_high_jogja.tx <- 
  stats::filter(xlag_high_jogja, 
 exp(coef(fit_beras_high_jogja.TFX)[c(3)]),
                method="convolution",
                sides = 1)

```

```{r Fungsi Transfer 2}

fit_beras_high_jogja.TF <- 
  Arima(data_high_jogja_train$harga,
        xreg = beras_high_jogja.tx,
        lambda = 0,
        order=c(1,1,1))

checkresiduals(fit_beras_high_jogja.TF)
shapiro.test(fit_beras_high_jogja.TF$residuals)
autoplot(fit_beras_high_jogja.TF)
summary(fit_beras_high_jogja.TF)
coeftest(fit_beras_high_jogja.TF)

```

```{r ARIMAX, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_high_jogja_train$harga)),
#         xreg=log1p(data_high_jogja_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_high_jogja.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)
forecast_high_jogja.TF <-
  forecast::forecast(fit_beras_high_jogja.TF,
                     xreg = ts(log1p(data_high_jogja_test$RR)))

MAPE(forecast_high_jogja.TF$mean,data_high_jogja_test$harga)
(postTest_beras_high_jogja.TF <- 
caret::postResample(data_high_jogja_test$harga,forecast_high_jogja.TF$mean))

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_high_jogja_test[,"tanggal"],
      y = as.numeric(data_high_jogja_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_jogja_test[,"tanggal"],
      y = as.numeric(forecast_high_jogja.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Premium Quailty Rice Price Yogyakarta")


#Check QQ-norm
# archres_high_jogja <- fit_beras_high_jogja.TF$residuals/fit_beras_high_jogja.garch@fitted
# qqnorm(archres_high_jogja)
# qqline(archres_high_jogja)

```

```{r SVR}
model_temp <- ARml(ts(data_high_jogja_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_high_jogja_train$RR), order.by=data_high_jogja_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.01, C = 100

fit_beras_high_jogja.SVR <- ARml(ts(data_high_jogja_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(150,120,100,80,60),
  sigma=c(0.01, 0.005, 0.05, 0.025, 0.0025)
),xreg=xts(log1p(data_high_jogja_train$RR), order.by=data_high_jogja_train$tanggal))

plot(fit_beras_high_jogja.SVR$model)
#Fitting sigma = 0.005, C = 80
```




```{r forecast}



forecast_high_jogja.SVR <- caretForecast::forecast(fit_beras_high_jogja.SVR, level = NULL, xreg = xts(log1p(data_high_jogja_test$RR), order.by = data_high_jogja_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_high_jogja.TF) + ylab("harga") +
    autolayer(ts(data_high_jogja$harga),series="Real data"),
  autoplot(forecast_high_jogja.SVR) + ylab("harga") +
    autolayer(ts(data_high_jogja$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_high_jogja_test$tanggal,
      y = as.numeric(data_high_jogja_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_jogja_test$tanggal,
      y = as.numeric(forecast_high_jogja.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted High Quailty Rice Price Yogykarta")

```

```{r akurasi model}
accuracy(forecast_high_jogja.TF,data_high_jogja_test$harga)
accuracy(forecast_high_jogja.SVR,data_high_jogja_test$harga)

MAPE(forecast_high_jogja.TF$mean,data_high_jogja_test$harga)
MAPE(forecast_high_jogja.SVR$mean,data_high_jogja_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_high_jogja.TF <- 
caret::postResample(data_high_jogja_train$harga,fit_beras_high_jogja.TF$fitted)

postFit_beras_high_jogja.SVR <- 
caret::postResample(data_high_jogja_train$harga[-c(1:fit_beras_high_jogja.SVR$max_lag+1)],na.omit(fit_beras_high_jogja.SVR$fitted))

postFit_beras_high_jogja <-
  matrix(c(postFit_beras_high_jogja.TF["RMSE"],
                postFit_beras_high_jogja.TF["MAE"],
                postFit_beras_high_jogja.TF["Rsquared"],
                postFit_beras_high_jogja.SVR["RMSE"],
                postFit_beras_high_jogja.SVR["MAE"],
                postFit_beras_high_jogja.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_high_jogja) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_high_jogja) <- c('ARIMAX','SVR')
postFit_beras_high_jogja <- round(as.table(postFit_beras_high_jogja),4)

###Hasil Error data Test
(postTest_beras_high_jogja.TF <- 
caret::postResample(data_high_jogja_test$harga,forecast_high_jogja.TF$mean))

(postTest_beras_high_jogja.SVR <- 
caret::postResample(data_high_jogja_test$harga,forecast_high_jogja.SVR$mean))

postTest_beras_high_jogja <-
  matrix(c(postTest_beras_high_jogja.TF["RMSE"],
                postTest_beras_high_jogja.TF["MAE"],
                postTest_beras_high_jogja.TF["Rsquared"],
                postTest_beras_high_jogja.SVR["RMSE"],
                postTest_beras_high_jogja.SVR["MAE"],
                postTest_beras_high_jogja.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_high_jogja) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_high_jogja) <- c('ARIMAX','SVR')
postTest_beras_high_jogja <- round(as.table(postTest_beras_high_jogja),4)

paste0("Model Fitting Error")
postFit_beras_high_jogja
paste0("Model Testing Error")
postTest_beras_high_jogja

# plot(beras_high_jogja.m1$x,col="red") +
# lines(fitted(beras_high_jogja.m1),col="blue")
# 
# plot(fit_beras_high_jogja.lm$x,col="red") +
# lines(fitted(fit_beras_high_jogja.lm),col="blue")


```


## Surabaya

```{r pre-processing data}
data_beras_surabaya_wonokromo <- subset(data_beras_jawa, 
                            kota == "Surabaya" & pasar == "Pasar Wonokromo")

data_beras_surabaya_tambah_rejo <- subset(data_beras_jawa, 
                            kota == "Surabaya" & pasar == "Pasar Tambah Rejo")

#bagi menjadi 3 kualitas
beras_low_surabaya_wonokromo <- subset(data_beras_surabaya_wonokromo, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_surabaya_wonokromo <- subset(data_beras_surabaya_wonokromo, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_surabaya_wonokromo <- subset(data_beras_surabaya_wonokromo, 
                            komoditas == 'Beras Kualitas Super I (kg)')

beras_low_surabaya_tambah_rejo <- subset(data_beras_surabaya_tambah_rejo, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_surabaya_tambah_rejo <- subset(data_beras_surabaya_tambah_rejo, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_surabaya_tambah_rejo <- subset(data_beras_surabaya_tambah_rejo, 
                            komoditas == 'Beras Kualitas Super I (kg)')



#impute data
beras_low_surabaya_wonokromo$harga <- na_interpolation(beras_low_surabaya_wonokromo$harga)
beras_med_surabaya_wonokromo$harga <- na_interpolation(beras_med_surabaya_wonokromo$harga)
beras_high_surabaya_wonokromo$harga <- na_interpolation(beras_high_surabaya_wonokromo$harga)

beras_low_surabaya_tambah_rejo$harga <- na_interpolation(beras_low_surabaya_tambah_rejo$harga)
beras_med_surabaya_tambah_rejo$harga <- na_interpolation(beras_med_surabaya_tambah_rejo$harga)
beras_high_surabaya_tambah_rejo$harga <- na_interpolation(beras_high_surabaya_tambah_rejo$harga)

#gabung semua pasar terhadap kualitasnya
##LOW - SURABAYA
beras_low_surabaya <- merge(x=beras_low_surabaya_wonokromo,
                            y=dplyr::select(beras_low_surabaya_tambah_rejo,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_low_surabaya <- merge(x=dplyr::select(beras_low_surabaya,tanggal,yearweeknum,harga),
                     y=data_klimatologi_surabaya_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)
##MED - SURABAYA
beras_med_surabaya <- merge(x=beras_med_surabaya_wonokromo,
                          y=dplyr::select(beras_med_surabaya_tambah_rejo,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_med_surabaya <- merge(x=dplyr::select(beras_med_surabaya,tanggal,yearweeknum,harga),
                     y=data_klimatologi_surabaya_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)

##HIGH - SURABAYA
beras_high_surabaya <- merge(x=beras_high_surabaya_wonokromo,
                          y=dplyr::select(beras_high_surabaya_tambah_rejo,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_high_surabaya <- merge(x=dplyr::select(beras_high_surabaya,tanggal,yearweeknum,harga),
                     y=data_klimatologi_surabaya_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)


###DIVIDE to TRAIN and TEST
data_low_surabaya_train <- data_low_surabaya[seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_surabaya))),]
data_low_surabaya_test <- data_low_surabaya[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_surabaya))),]

data_med_surabaya_train <- data_med_surabaya[seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_surabaya))),]
data_med_surabaya_test <- data_med_surabaya[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_surabaya))),]

data_high_surabaya_train <- data_high_surabaya[seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_surabaya))),]
data_high_surabaya_test <- data_high_surabaya[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_surabaya))),]

```


```{r ploting data harga, warning=FALSE}

gridExtra::grid.arrange(
  autoplot(xts(data_low_surabaya$harga, order.by = data_low_surabaya$tanggal)) + xlab("") + ylab("harga") + ggtitle("Kualitas Rendah"),
  autoplot(xts(data_med_surabaya$harga, order.by = data_med_surabaya$tanggal)) + ggtitle("Kualitas Medium") + xlab("") + ylab("harga"),
  autoplot(xts(data_high_surabaya$harga, order.by = data_high_surabaya$tanggal)) + ggtitle("Kualitas Premium") + xlab("tanggal") + ylab("harga"),
  top = "Harga Beras surabaya"
  ) 

```


###Surabaya - Low
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_low_surabaya_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_low_surabaya.lm <- lm(log(harga) ~ log1p(RR), data=data_low_surabaya_train)

coeftest(fit_beras_low_surabaya.lm)
summary(fit_beras_low_surabaya.lm)
# auto.arima(data_low_surabaya_train[,"harga"], xreg = log1p(data_low_surabaya_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_low_surabaya.lm$residuals)
auto.arima(fit_beras_low_surabaya.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_low_surabaya.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_low_surabaya.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_low_surabaya.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_low_surabaya.lm$residuals),1), ma.max=7) 

temp.model <- list(c(0,1,1),c(1,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_low_surabaya.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(1,1,1)



#model arima
res_beras_low_surabaya.m1 <- 
  Arima(fit_beras_low_surabaya.lm$residuals, 
        order=c(1,1,1))
summary(res_beras_low_surabaya.m1)
coeftest(res_beras_low_surabaya.m1)
checkresiduals(res_beras_low_surabaya.m1)
shapiro.test(res_beras_low_surabaya.m1$residuals)
#white noise

Arima(ts(data_low_surabaya_train$harga),
      order = c(1,1,1),
      xreg = ts(log1p(data_low_surabaya_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_low_surabaya <- 
  prewhiten(x=data_low_surabaya_train$harga,
            y=data_low_surabaya_train$RR, 
            x.model = Arima(data_low_surabaya_train$harga, order = c(1,0,0)))
ccf_low_surabaya$ccf 

# b=0
xlag_low_surabaya <- ts(Lag(log1p(data_low_surabaya_train[,"RR"]),0))
xlag_low_surabaya[is.na(xlag_low_surabaya)]=0
fit_beras_low_surabaya.TFX_temp <-
  arimax(ts(log(data_low_surabaya_train[,"harga"])),
         order=c(1,1,1),
         xtransf = xlag_low_surabaya, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_low_surabaya.TFX_temp)


fit_beras_low_surabaya.TF <- 
  Arima(data_low_jogja_train$harga,
        xreg = log1p(data_low_surabaya_train[,"RR"]),
        lambda = 0,
        order=c(1,1,1))

checkresiduals(fit_beras_low_surabaya.TF)
shapiro.test(fit_beras_low_surabaya.TF$residuals)
autoplot(fit_beras_low_surabaya.TF)
summary(fit_beras_low_surabaya.TF)
coeftest(fit_beras_low_surabaya.TF)

```

```{r ARIMAX, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_low_surabaya_train$harga)),
#         xreg=log1p(data_low_surabaya_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_low_surabaya.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

#Tidak ada arch effect (homokedastisitas)
forecast_low_surabaya.TF <-
  forecast::forecast(fit_beras_low_surabaya.TF,
                     xreg = ts(log1p(data_low_surabaya_test$RR)))

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_low_surabaya_test[,"tanggal"],
      y = as.numeric(data_low_surabaya_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_surabaya_test[,"tanggal"],
      y = as.numeric(forecast_low_surabaya.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Surabaya")


# #Check QQ-norm
# archres_low_surabaya <- fit_beras_low_surabaya.TF$residuals/fit_beras_low_surabaya.garch@fitted
# qqnorm(archres_low_surabaya)
# qqline(archres_low_surabaya)

```


```{r SVR}
model_temp <- ARml(ts(data_low_surabaya_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_low_surabaya_train$RR), order.by=data_low_surabaya_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.001, C = 100

fit_beras_low_surabaya.SVR <- ARml(ts(data_low_surabaya_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(80,100,150,200,250),
  sigma=c(0.0001, 0.0005, 0.001, 0.002, 0.005)
),xreg=xts(log1p(data_low_surabaya_train$RR), order.by=data_low_surabaya_train$tanggal))

plot(fit_beras_low_surabaya.SVR$model)
#Fitting sigma = 0.0001, C = 150
```

```{r forecast}

forecast_low_surabaya.SVR <- caretForecast::forecast(fit_beras_low_surabaya.SVR, level = NULL, xreg = xts(log1p(data_low_surabaya_test$RR), order.by = data_low_surabaya_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_low_surabaya.TF) + ylab("harga") +
    autolayer(ts(data_low_surabaya$harga),series="Real data"),
  autoplot(forecast_low_surabaya.SVR) + ylab("harga") +
    autolayer(ts(data_low_surabaya$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_low_surabaya_test$tanggal,
      y = as.numeric(data_low_surabaya_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_surabaya_test$tanggal,
      y = as.numeric(forecast_low_surabaya.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Surabaya")

```

```{r akurasi model}
accuracy(forecast_low_surabaya.TF,data_low_surabaya_test$harga)
accuracy(forecast_low_surabaya.SVR,data_low_surabaya_test$harga)

MAPE(forecast_low_surabaya.TF$mean,data_low_surabaya_test$harga)
MAPE(forecast_low_surabaya.SVR$mean,data_low_surabaya_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_low_surabaya.TF <- 
caret::postResample(data_low_surabaya_train$harga,fit_beras_low_surabaya.TF$fitted)

postFit_beras_low_surabaya.SVR <- 
caret::postResample(data_low_surabaya_train$harga[-c(1:fit_beras_low_surabaya.SVR$max_lag+1)],na.omit(fit_beras_low_surabaya.SVR$fitted))

postFit_beras_low_surabaya <-
  matrix(c(postFit_beras_low_surabaya.TF["RMSE"],
                postFit_beras_low_surabaya.TF["MAE"],
                postFit_beras_low_surabaya.TF["Rsquared"],
                postFit_beras_low_surabaya.SVR["RMSE"],
                postFit_beras_low_surabaya.SVR["MAE"],
                postFit_beras_low_surabaya.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_low_surabaya) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_low_surabaya) <- c('ARIMAX','SVR')
postFit_beras_low_surabaya <- round(as.table(postFit_beras_low_surabaya),4)

###Hasil Error data Test
(postTest_beras_low_surabaya.TF <- 
caret::postResample(data_low_surabaya_test$harga,forecast_low_surabaya.TF$mean))

(postTest_beras_low_surabaya.SVR <- 
caret::postResample(data_low_surabaya_test$harga,forecast_low_surabaya.SVR$mean))

postTest_beras_low_surabaya <-
  matrix(c(postTest_beras_low_surabaya.TF["RMSE"],
                postTest_beras_low_surabaya.TF["MAE"],
                postTest_beras_low_surabaya.TF["Rsquared"],
                postTest_beras_low_surabaya.SVR["RMSE"],
                postTest_beras_low_surabaya.SVR["MAE"],
                postTest_beras_low_surabaya.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_low_surabaya) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_low_surabaya) <- c('ARIMAX','SVR')
postTest_beras_low_surabaya <- round(as.table(postTest_beras_low_surabaya),4)

paste0("Model Fitting Error")
postFit_beras_low_surabaya
paste0("Model Testing Error")
postTest_beras_low_surabaya

# plot(beras_low_surabaya.m1$x,col="red") +
# lines(fitted(beras_low_surabaya.m1),col="blue")
# 
# plot(fit_beras_low_surabaya.lm$x,col="red") +
# lines(fitted(fit_beras_low_surabaya.lm),col="blue")


```

###Surabaya - Med
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_med_surabaya_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_med_surabaya.lm <- lm(log(harga) ~ log1p(RR), data=data_med_surabaya_train)

coeftest(fit_beras_med_surabaya.lm)
summary(fit_beras_med_surabaya.lm)
# auto.arima(data_med_surabaya_train[,"harga"], xreg = log1p(data_med_surabaya_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_med_surabaya.lm$residuals)
auto.arima(fit_beras_med_surabaya.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_med_surabaya.lm$residuals),1))

```




```{r SVR}
model_temp <- ARml(ts(data_med_surabaya_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_med_surabaya_train$RR), order.by=data_med_surabaya_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.001, C = 1000

fit_beras_med_surabaya.SVR <- ARml(ts(data_med_surabaya_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(800,900,1000,1100,1200),
  sigma=c(0.0001, 0.0005, 0.001, 0.002, 0.005)
),xreg=xts(log1p(data_med_surabaya_train$RR), order.by=data_med_surabaya_train$tanggal))

plot(fit_beras_med_surabaya.SVR$model)
#Fitting sigma = 0.001, C = 900
```

```{r forecast}
forecast_med_surabaya.TF <-
  forecast::forecast(fit_beras_med_surabaya.TF,
                     xreg = ts(log1p(data_med_surabaya_test$RR)))


forecast_med_surabaya.SVR <- caretForecast::forecast(fit_beras_med_surabaya.SVR, level = NULL, xreg = xts(log1p(data_med_surabaya_test$RR), order.by = data_med_surabaya_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_med_surabaya.TF) + ylab("harga") +
    autolayer(ts(data_med_surabaya$harga),series="Real data"),
  autoplot(forecast_med_surabaya.SVR) + ylab("harga") +
    autolayer(ts(data_med_surabaya$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_med_surabaya_test$tanggal,
      y = as.numeric(data_med_surabaya_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_surabaya_test$tanggal,
      y = as.numeric(forecast_med_surabaya.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Surabaya")

```

```{r akurasi model}
accuracy(forecast_med_surabaya.TF,data_med_surabaya_test$harga)
accuracy(forecast_med_surabaya.SVR,data_med_surabaya_test$harga)

MAPE(forecast_med_surabaya.TF$mean,data_med_surabaya_test$harga)
MAPE(forecast_med_surabaya.SVR$mean,data_med_surabaya_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_med_surabaya.TF <- 
caret::postResample(data_med_surabaya_train$harga,fit_beras_med_surabaya.TF$fitted)

postFit_beras_med_surabaya.SVR <- 
caret::postResample(data_med_surabaya_train$harga[-c(1:fit_beras_med_surabaya.SVR$max_lag+1)],na.omit(fit_beras_med_surabaya.SVR$fitted))

postFit_beras_med_surabaya <-
  matrix(c(postFit_beras_med_surabaya.TF["RMSE"],
                postFit_beras_med_surabaya.TF["MAE"],
                postFit_beras_med_surabaya.TF["Rsquared"],
                postFit_beras_med_surabaya.SVR["RMSE"],
                postFit_beras_med_surabaya.SVR["MAE"],
                postFit_beras_med_surabaya.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_med_surabaya) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_med_surabaya) <- c('ARIMAX','SVR')
postFit_beras_med_surabaya <- round(as.table(postFit_beras_med_surabaya),4)

###Hasil Error data Test
postTest_beras_med_surabaya.TF <- 
caret::postResample(data_med_surabaya_test$harga,forecast_med_surabaya.TF$mean)

(postTest_beras_med_surabaya.SVR <- 
caret::postResample(data_med_surabaya_test$harga,forecast_med_surabaya.SVR$mean))

postTest_beras_med_surabaya <-
  matrix(c(postTest_beras_med_surabaya.TF["RMSE"],
                postTest_beras_med_surabaya.TF["MAE"],
                postTest_beras_med_surabaya.TF["Rsquared"],
                postTest_beras_med_surabaya.SVR["RMSE"],
                postTest_beras_med_surabaya.SVR["MAE"],
                postTest_beras_med_surabaya.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_med_surabaya) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_med_surabaya) <- c('ARIMAX','SVR')
postTest_beras_med_surabaya <- round(as.table(postTest_beras_med_surabaya),4)

paste0("Model Fitting Error")
postFit_beras_med_surabaya
paste0("Model Testing Error")
postTest_beras_med_surabaya

# plot(beras_med_surabaya.m1$x,col="red") +
# lines(fitted(beras_med_surabaya.m1),col="blue")
# 
# plot(fit_beras_med_surabaya.lm$x,col="red") +
# lines(fitted(fit_beras_med_surabaya.lm),col="blue")


```

```{r ARIMA-GARCH, warning=FALSE}
aTSA::arch.test(arima(ts(data_med_surabaya_train$harga),
        xreg=beras_med_surabaya.tx,
        order=c(1,1,0)))
# #proper time series data
# beras_med_surabaya_xts <- xts(data_med_surabaya_train$harga, 
#              order.by = data_med_surabaya_train$tanggal)
# 
# beras_med_surabaya_xts.m0 <- 
#   diff(beras_med_surabaya_xts,1)[-c(1)]
# 
# beras_med_surabaya.m2 <- 
#   arima(data_med_surabaya_train$harga, 
#         order=c(1,1,0))
# 
# #cek arch test
# aTSA::arch.test(beras_med_surabaya.m2)
# #ditunjukkan terdapat hetereoscedasticity
# 
# #Pemodelan garch
# fit_beras_med_surabaya.garch <- garchFit(formula = ~arma(1,0)+garch(1,2),
#          data = beras_med_surabaya_xts.m0,
#          trace = F)
# summary(fit_beras_med_surabaya.garch)
# 
# stdev_1 <- xts(fit_beras_med_surabaya.garch@sigma.t, 
#              order.by = data_med_surabaya_train$tanggal[-1])
# 
# plot(xts(fit_beras_med_surabaya.garch@sigma.t, order.by = data_med_surabaya_train$tanggal[-c(1)]))
# predict_garch_med_surabaya <- fGarch::predict(fit_beras_med_surabaya.garch, n.ahead=5, plot=TRUE, nx=214)
# #Forecast
# addmean <- predict_garch_med_surabaya$meanForecast[1]
# addstdev <- predict_garch_med_surabaya$standardDeviation[1]
# dates2 <- as.Date("2021-09-06")
# meanf <- xts(addmean, order.by=dates2)
# stdev_1 <- xts(addstdev, order.by=dates2)
# beras_med_surabaya_xts.m0.f <- rbind(beras_med_surabaya_xts.m0, meanf)
# #stdevf <- rbind(stdev, stdev_1)
# 
# fit_beras_med_surabaya.garch.f <- garchFit(formula = ~arma(1,0)+garch(1,2),
#                     data = beras_med_surabaya_xts.m0.f,
#                     trace = F)
# 
# for (i in 1:length(data_med_surabaya_test$harga)-1){
#   dates3 <- dates2+7*i
#   meanf <- xts(addmean, order.by=dates3)
#   stdevf1 <- xts(addstdev, order.by=dates3)
#   beras_med_surabaya_xts.m0.f <- rbind(beras_med_surabaya_xts.m0.f, meanf)
#   stdevf <- rbind(stdevf, stdevf1)
#   
#   fit_beras_med_surabaya.garch.f <- garchFit(formula = ~arma(1,2)+garch(1,2),
#                        data = beras_med_surabaya_xts.m0.f,
#                        trace = F)
#   temp1 <- fGarch::predict(fit_beras_med_surabaya.garch.f, n.ahead=1, plot=FALSE, nx=215+i)
#   addmean <- temp1$meanForecast
#   addstdev <- temp1$standardDeviation
# }
# 
# #undo differencing
# beras_med_surabaya_xts.m0.f2 <- rbind(beras_med_surabaya_xts[1], (cumsum(beras_med_surabaya_xts.m0.f) + data_med_surabaya_train$harga[1]))
# 
# plot(xts(data_med_surabaya$harga, order.by = data_med_surabaya$tanggal), col="blue", ylim=c(min(min(beras_med_surabaya_xts.m0.f2[c(214:268)]),min(data_med_surabaya$harga)),max(max(beras_med_surabaya_xts.m0.f2[c(214:268)]),max(data_med_surabaya$harga)))) 
# lines(beras_med_surabaya_xts.m0.f2[c(214:268)],col="red", lwd=2)
```

###Surabaya - High
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_high_surabaya_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_high_surabaya.lm <- lm(log(harga) ~ log1p(RR), data=data_high_surabaya_train)

coeftest(fit_beras_high_surabaya.lm)
summary(fit_beras_high_surabaya.lm)
# auto.arima(data_high_surabaya_train[,"harga"], xreg = log1p(data_high_surabaya_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_high_surabaya.lm$residuals)
auto.arima(fit_beras_high_surabaya.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_high_surabaya.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_high_surabaya.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_high_surabaya.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_high_surabaya.lm$residuals),1), ma.max=7) 

temp.model <- list(c(0,1,1),c(1,1,1), c(2,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_high_surabaya.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(1,1,1)



#model arima
res_beras_high_surabaya.m1 <- 
  Arima(fit_beras_high_surabaya.lm$residuals, 
        order=c(1,1,1))
summary(res_beras_high_surabaya.m1)
coeftest(res_beras_high_surabaya.m1)
checkresiduals(res_beras_high_surabaya.m1)
shapiro.test(res_beras_high_surabaya.m1$residuals)
#white noise

Arima(ts(data_high_surabaya_train$harga),
      order = c(0,1,1),
      xreg = ts(log1p(data_high_surabaya_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_high_surabaya <- 
  prewhiten(x=data_high_surabaya_train$harga,
            y=data_high_surabaya_train$RR, 
            x.model = Arima(data_high_surabaya_train$harga, order = c(1,0,0)))
ccf_high_surabaya$ccf 

# b=0
xlag_high_surabaya <- ts(Lag(log1p(data_high_surabaya_train[,"RR"]),0))
xlag_high_surabaya[is.na(xlag_high_surabaya)]=0
fit_beras_high_surabaya.TFX_temp <-
  arimax(ts(log(data_high_surabaya_train[,"harga"])),
         order=c(1,1,1),
         xtransf = xlag_high_surabaya, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_high_surabaya.TFX_temp)


fit_beras_high_jogja.TF <- 
  Arima(data_high_jogja_train$harga,
        xreg = log1p(data_high_surabaya_train[,"RR"]),
        lambda = 0,
        order=c(1,1,1))

checkresiduals(fit_beras_high_surabaya.TF)
shapiro.test(fit_beras_high_surabaya.TF$residuals)
autoplot(fit_beras_high_surabaya.TF)
summary(fit_beras_high_surabaya.TF)
coeftest(fit_beras_high_surabaya.TF)

```

```{r ARIMAX-GARCH, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_high_surabaya_train$harga)),
#         xreg=log1p(data_high_surabaya_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_high_surabaya.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result


#searching for best garch model
aic.garch <- matrix(0,3,4)
bic.garch <- matrix(0,3,4)
for (i in 1:3) {
  for (j in 0:3) {
    garch.spec = ugarchspec(variance.model = list(garchOrder=c(i,j)), 
                            mean.model = list(armaOrder=c(0,0),include.mean = FALSE),
                            distribution.model = "std")
    garch.fit = ugarchfit(spec=garch.spec, data=na.omit(fit_beras_high_surabaya.TF$residuals),
                          solver.control=list(trace = F))
    aic.garch[i,j+1] <- infocriteria(garch.fit)[1]
    bic.garch[i,j+1] <- infocriteria(garch.fit)[2]
  }
}
aic.garch
bic.garch
min(aic.garch) # garch(1,1)

#Pemodelan garch
#uji coba fitting model
fit_beras_high_surabaya.garch <- garchFit(formula = ~arma(0,0)+garch(1,1),
         data = na.omit(fit_beras_high_surabaya.TF$residuals),
         trace = F, include.mean = F)
summary(fit_beras_high_surabaya.garch)
#summary LM Arch Test sudah tidak hetero

stdev_high_surabaya <- xts(fit_beras_high_surabaya.garch@sigma.t, order.by = data_high_surabaya_train$tanggal)

plot(xts(fit_beras_high_surabaya.garch@sigma.t, order.by = data_high_surabaya_train$tanggal))
predict_garch_high_surabaya <- fGarch::predict(fit_beras_high_surabaya.garch, n.ahead=5, plot=TRUE, nx=214)

#Forecast
addmean <- predict_garch_high_surabaya$meanForecast[1]
addstdev <- predict_garch_high_surabaya$standardDeviation[1]
dates2 <- as.Date("2021-09-06")
mean_high_surabaya <- xts(addmean, order.by=dates2)
stdev_1 <- xts(addstdev, order.by=dates2)
beras_high_surabaya_xts.m0.f <- rbind(na.omit(fit_beras_high_surabaya.TF$residuals), mean_high_surabaya)
stdev_high_surabaya <- rbind(stdev_high_surabaya, stdev_1)

fit_beras_high_surabaya.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,0), data = beras_high_surabaya_xts.m0.f, trace = F)

#Looping predict, karena jika predict terlalu jauh akan menghasilkan nilai yang serupa
for (i in 1:length(data_high_surabaya_test$harga)-1){
  dates3 <- dates2+7*i
  meanf <- xts(addmean, order.by=dates3)
  stdevf <- xts(addstdev, order.by=dates3)
  beras_high_surabaya_xts.m0.f <- rbind(beras_high_surabaya_xts.m0.f, meanf)
  stdev_high_surabaya <- rbind(stdev_high_surabaya, stdevf)
  
  fit_beras_high_surabaya.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,0),
                       data = beras_high_surabaya_xts.m0.f,
                       trace = F)
  temp1 <- fGarch::predict(fit_beras_high_surabaya.garch.f, n.ahead=1, plot=FALSE, nx=215+i)
  addmean <- temp1$meanForecast
  addstdev <- temp1$standardDeviation
}

forecast_high_surabaya.TF <-
  forecast::forecast(fit_beras_high_surabaya.TF,
                     xreg = ts(log1p(data_high_surabaya_test$RR)))

#ambil data forecast saja
forecast_high_surabaya.TF_residual <- exp(beras_high_surabaya_xts.m0.f[-c(1:215)])

#buat variabel baru untuk join forecasting

forecast_high_surabaya.TF_join <- forecast_high_surabaya.TF$mean+forecast_high_surabaya.TF_residual

#Forecast ARIMAX-GARCH
autoplot(forecast_high_surabaya.TF_join) + ylab("harga") +
    autolayer(ts(data_high_surabaya$harga),series="Real data")

accuracy(forecast_high_surabaya.TF_join, data_high_surabaya_test$harga)

ggplot() +
  geom_line(
    aes(
      x = data_high_surabaya_test[,"tanggal"],
      y = as.numeric(data_high_surabaya_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_surabaya_test[,"tanggal"],
      y = as.numeric(forecast_high_surabaya.TF_join),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Premium Quailty Rice Price Surabaya")


#Check QQ-norm
# archres_high_surabaya <- fit_beras_high_surabaya.TF$residuals/fit_beras_high_surabaya.garch@fitted
# qqnorm(archres_high_surabaya)
# qqline(archres_high_surabaya)

```

```{r SVR}
model_temp <- ARml(ts(data_high_surabaya_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_high_surabaya_train$RR), order.by=data_high_surabaya_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.1, C = 1000

fit_beras_high_surabaya.SVR <- ARml(ts(data_high_surabaya_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(500,900,1000,1100,1200),
  sigma=c(0.03,0.05,0.1, 0.15, 0.2)
),xreg=xts(log1p(data_high_surabaya_train$RR), order.by=data_high_surabaya_train$tanggal))

plot(fit_beras_high_surabaya.SVR$model)
#Fitting sigma = 0.1, C = 1100
```

```{r forecast}


forecast_high_surabaya.SVR <- caretForecast::forecast(fit_beras_high_surabaya.SVR, level = NULL, xreg = xts(log1p(data_high_surabaya_test$RR), order.by = data_high_surabaya_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_high_surabaya.TF) + ylab("harga") +
    autolayer(ts(data_high_surabaya$harga),series="Real data"),
  autoplot(forecast_high_surabaya.SVR) + ylab("harga") +
    autolayer(ts(data_high_surabaya$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_high_surabaya_test$tanggal,
      y = as.numeric(data_high_surabaya_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_surabaya_test$tanggal,
      y = as.numeric(forecast_high_surabaya.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted High Quailty Rice Price Surabaya")

```

```{r akurasi model}
accuracy(forecast_high_surabaya.TF,data_high_surabaya_test$harga)
accuracy(forecast_high_surabaya.SVR,data_high_surabaya_test$harga)

MAPE(forecast_high_surabaya.TF_join,data_high_surabaya_test$harga)
MAPE(forecast_high_surabaya.SVR$mean,data_high_surabaya_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_high_surabaya.TF <- 
caret::postResample(data_high_surabaya_train$harga,fit_beras_high_surabaya.TF$fitted)

postFit_beras_high_surabaya.SVR <- 
caret::postResample(data_high_surabaya_train$harga[-c(1:fit_beras_high_surabaya.SVR$max_lag+1)],na.omit(fit_beras_high_surabaya.SVR$fitted))

postFit_beras_high_surabaya <-
  matrix(c(postFit_beras_high_surabaya.TF["RMSE"],
                postFit_beras_high_surabaya.TF["MAE"],
                postFit_beras_high_surabaya.TF["Rsquared"],
                postFit_beras_high_surabaya.SVR["RMSE"],
                postFit_beras_high_surabaya.SVR["MAE"],
                postFit_beras_high_surabaya.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_high_surabaya) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_high_surabaya) <- c('ARIMAX','SVR')
postFit_beras_high_surabaya <- round(as.table(postFit_beras_high_surabaya),4)

###Hasil Error data Test
(postTest_beras_high_surabaya.TF <- 
caret::postResample(data_high_surabaya_test$harga,forecast_high_surabaya.TF$mean))

(postTest_beras_high_surabaya.SVR <- 
caret::postResample(data_high_surabaya_test$harga,forecast_high_surabaya.SVR$mean))

postTest_beras_high_surabaya <-
  matrix(c(postTest_beras_high_surabaya.TF["RMSE"],
                postTest_beras_high_surabaya.TF["MAE"],
                postTest_beras_high_surabaya.TF["Rsquared"],
                postTest_beras_high_surabaya.SVR["RMSE"],
                postTest_beras_high_surabaya.SVR["MAE"],
                postTest_beras_high_surabaya.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_high_surabaya) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_high_surabaya) <- c('ARIMAX','SVR')
postTest_beras_high_surabaya <- round(as.table(postTest_beras_high_surabaya),4)

paste0("Model Fitting Error")
postFit_beras_high_surabaya
paste0("Model Testing Error")
postTest_beras_high_surabaya

# plot(beras_high_surabaya.m1$x,col="red") +
# lines(fitted(beras_high_surabaya.m1),col="blue")
# 
# plot(fit_beras_high_surabaya.lm$x,col="red") +
# lines(fitted(fit_beras_high_surabaya.lm),col="blue")


```


## Malang

```{r pre-processing data}
#data harga beras
data_beras_malang_dinoyo <- subset(data_beras_jawa, 
                            kota == "Malang" & pasar == "Pasar Dinoyo")

data_beras_malang_pasar_besar <- subset(data_beras_jawa, 
                            kota == "Malang" & pasar == "Pasar Besar")

#bagi menjadi 3 kualitas
beras_low_malang_dinoyo <- subset(data_beras_malang_dinoyo, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_malang_dinoyo <- subset(data_beras_malang_dinoyo, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_malang_dinoyo <- subset(data_beras_malang_dinoyo, 
                            komoditas == 'Beras Kualitas Super I (kg)')

beras_low_malang_pasar_besar <- subset(data_beras_malang_pasar_besar, 
                           komoditas == 'Beras Kualitas Bawah I (kg)')
beras_med_malang_pasar_besar <- subset(data_beras_malang_pasar_besar, 
                           komoditas == 'Beras Kualitas Medium I (kg)')
beras_high_malang_pasar_besar <- subset(data_beras_malang_pasar_besar, 
                            komoditas == 'Beras Kualitas Super I (kg)')


#impute data
beras_low_malang_dinoyo$harga <- na_interpolation(beras_low_malang_dinoyo$harga)
beras_med_malang_dinoyo$harga <- na_interpolation(beras_med_malang_dinoyo$harga)
beras_high_malang_dinoyo$harga <- na_interpolation(beras_high_malang_dinoyo$harga)

beras_low_malang_pasar_besar$harga <- na_interpolation(beras_low_malang_pasar_besar$harga)
beras_med_malang_pasar_besar$harga <- na_interpolation(beras_med_malang_pasar_besar$harga)
beras_high_malang_pasar_besar$harga <- na_interpolation(beras_high_malang_pasar_besar$harga)

#gabung semua pasar terhadap kualitasnya
##LOW - MALANG
beras_low_malang <- merge(x=beras_low_malang_dinoyo,
                          y=dplyr::select(beras_low_malang_pasar_besar,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_low_malang <- merge(x=dplyr::select(beras_low_malang,tanggal,yearweeknum,harga),
                     y=data_klimatologi_malang_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)
##MED - MALANG
beras_med_malang <- merge(x=beras_med_malang_dinoyo,
              y=dplyr::select(beras_med_malang_pasar_besar,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>%  mutate(harga = (harga.x + harga.y)/2)

data_med_malang <- merge(x=dplyr::select(beras_med_malang,tanggal,yearweeknum,harga),
                     y=data_klimatologi_malang_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)

##HIGH - MALANG
beras_high_malang <- merge(x=beras_high_malang_dinoyo,
 y=dplyr::select(beras_high_malang_pasar_besar,-tanggal),
                          by="yearweeknum",
                          all.x=TRUE,
                          all.y=TRUE) %>% mutate(harga = (harga.x + harga.y)/2)

data_high_malang <- merge(x=dplyr::select(beras_high_malang,tanggal,yearweeknum,harga),
                     y=data_klimatologi_malang_week, 
                     by="yearweeknum", 
                     all.x=TRUE) %>% arrange(tanggal)

###DIVIDE to TRAIN and TEST
data_low_malang_train <- data_low_malang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_malang))),]
data_low_malang_test <- data_low_malang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_low_malang))),]

data_med_malang_train <- data_med_malang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_malang))),]
data_med_malang_test <- data_med_malang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_med_malang))),]

data_high_malang_train <- data_high_malang[seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_malang))),]
data_high_malang_test <- data_high_malang[-seq_len(length.out = floor(x = 0.8 * nrow(x = data_high_malang))),]


```


```{r ploting data harga, warning=FALSE}
#perbandingan sebelum dan sesudah imputation untuk kolom harga

gridExtra::grid.arrange(
  autoplot(xts(data_low_malang$harga, order.by = data_low_malang$tanggal)) + xlab("") + ylab("harga") + ggtitle("Kualitas Rendah"),
  autoplot(xts(data_med_malang$harga, order.by = data_med_malang$tanggal)) + ggtitle("Kualitas Medium") + xlab("") + ylab("harga"),
  autoplot(xts(data_high_malang$harga, order.by = data_high_malang$tanggal)) + ggtitle("Kualitas Premium") + xlab("tanggal") + ylab("harga"),
  top = "Harga Beras Malang"
  ) 

```

###Malang - Low
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_low_malang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_low_malang.lm <- lm(log(harga) ~ log1p(RR), data=data_low_malang_train)

coeftest(fit_beras_low_malang.lm)
summary(fit_beras_low_malang.lm)
# auto.arima(data_low_malang_train[,"harga"], xreg = log1p(data_low_malang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_low_malang.lm$residuals)
auto.arima(fit_beras_low_malang.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_low_malang.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_low_malang.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_low_malang.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_low_malang.lm$residuals),1), ma.max=7) 

temp.model <- list(c(1,1,0),c(1,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_low_malang.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(1,1,1)



#model arima
res_beras_low_malang.m1 <- 
  Arima(fit_beras_low_malang.lm$residuals, 
        order=c(1,1,1))
summary(res_beras_low_malang.m1)
coeftest(res_beras_low_malang.m1)
checkresiduals(res_beras_low_malang.m1)
shapiro.test(res_beras_low_malang.m1$residuals)
#white noise

Arima(ts(data_low_malang_train$harga),
      order = c(1,1,1),
      xreg = ts(log1p(data_low_malang_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_low_malang <- 
  prewhiten(x=data_low_malang_train$harga,
            y=data_low_malang_train$RR, 
            x.model = Arima(data_low_malang_train$harga, order = c(1,0,0)))
ccf_low_malang$ccf 

# b=0
xlag_low_malang <- ts(Lag(log1p(data_low_malang_train[,"RR"]),0))
xlag_low_malang[is.na(xlag_low_malang)]=0
fit_beras_low_malang.TFX_temp <-
  arimax(ts(log(data_low_malang_train[,"harga"])),
         order=c(1,1,1),
         xtransf = xlag_low_malang, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_low_malang.TFX_temp)


fit_beras_low_malang.TF <- 
  Arima(data_low_malang_train$harga,
        xreg = log1p(data_low_malang_train[,"RR"]),
        lambda = 0,
        order=c(1,1,1))

checkresiduals(fit_beras_low_malang.TF)
shapiro.test(fit_beras_low_malang.TF$residuals)
autoplot(fit_beras_low_malang.TF)
summary(fit_beras_low_malang.TF)
coeftest(fit_beras_low_malang.TF)

```

```{r ARIMAX-GARCH, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_low_malang_train$harga)),
#         xreg=log1p(data_low_malang_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_low_malang.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result



#searching for best garch model
aic.garch <- matrix(0,3,4)
bic.garch <- matrix(0,3,4)
for (i in 1:3) {
  for (j in 0:3) {
    garch.spec = ugarchspec(variance.model = list(garchOrder=c(i,j)), 
                            mean.model = list(armaOrder=c(0,0),include.mean = FALSE),
                            distribution.model = "std")
    garch.fit = ugarchfit(spec=garch.spec, data=na.omit(fit_beras_low_malang.TF$residuals),
                          solver.control=list(trace = F))
    aic.garch[i,j+1] <- infocriteria(garch.fit)[1]
    bic.garch[i,j+1] <- infocriteria(garch.fit)[2]
  }
}
aic.garch
bic.garch
min(aic.garch) # garch(1,1)

#Pemodelan garch
#uji coba fitting model
fit_beras_low_malang.garch <- garchFit(formula = ~arma(0,0)+garch(1,1),
         data = na.omit(fit_beras_low_malang.TF$residuals),
         trace = F, include.mean = F)
summary(fit_beras_low_malang.garch)
#summary LM Arch Test sudah tidak hetero

stdev_low_malang <- xts(fit_beras_low_malang.garch@sigma.t, order.by = data_low_malang_train$tanggal)

plot(xts(fit_beras_low_malang.garch@sigma.t, order.by = data_low_malang_train$tanggal))
predict_garch_low_malang <- fGarch::predict(fit_beras_low_malang.garch, n.ahead=5, plot=TRUE, nx=214)

#Forecast
addmean <- predict_garch_low_malang$meanForecast[1]
addstdev <- predict_garch_low_malang$standardDeviation[1]
dates2 <- as.Date("2021-09-06")
mean_low_malang <- xts(addmean, order.by=dates2)
stdev_1 <- xts(addstdev, order.by=dates2)
beras_low_malang_xts.m0.f <- rbind(na.omit(fit_beras_low_malang.TF$residuals), mean_low_malang)
stdev_low_malang <- rbind(stdev_low_malang, stdev_1)

fit_beras_low_malang.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,1), data = beras_low_malang_xts.m0.f, trace = F)

#Looping predict, karena jika predict terlalu jauh akan menghasilkan nilai yang serupa
for (i in 1:length(data_low_malang_test$harga)-1){
  dates3 <- dates2+7*i
  meanf <- xts(addmean, order.by=dates3)
  stdevf <- xts(addstdev, order.by=dates3)
  beras_low_malang_xts.m0.f <- rbind(beras_low_malang_xts.m0.f, meanf)
  stdev_low_malang <- rbind(stdev_low_malang, stdevf)
  
  fit_beras_low_malang.garch.f <- garchFit(formula = ~arma(0,0)+garch(1,1),
                       data = beras_low_malang_xts.m0.f,
                       trace = F)
  temp1 <- fGarch::predict(fit_beras_low_malang.garch.f, n.ahead=1, plot=FALSE, nx=215+i)
  addmean <- temp1$meanForecast
  addstdev <- temp1$standardDeviation
}

#ambil data forecast saja
forecast_low_malang.TF <-
  forecast::forecast(fit_beras_low_malang.TF,
                     xreg = ts(log1p(data_low_malang_test$RR)))

forecast_low_malang.TF_residual <- exp(beras_low_malang_xts.m0.f[-c(1:215)])

#buat variabel baru untuk join forecasting

forecast_low_malang.TF_join <- forecast_low_malang.TF$mean+forecast_low_malang.TF_residual

#Forecast ARIMAX-GARCH
autoplot(forecast_low_malang.TF_join) + ylab("harga") +
    autolayer(ts(data_low_malang$harga),series="Real data")

accuracy(forecast_low_malang.TF_join, data_low_malang_test$harga)

ggplot() +
  geom_line(
    aes(
      x = data_low_malang_test[,"tanggal"],
      y = as.numeric(data_low_malang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_malang_test[,"tanggal"],
      y = as.numeric(forecast_low_malang.TF_join),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Malang")


#Check QQ-norm
# archres_low_malang <- fit_beras_low_malang.TF$residuals/fit_beras_low_malang.garch@fitted
# qqnorm(archres_low_malang)
# qqline(archres_low_malang)
```


```{r SVR}
model_temp <- ARml(ts(data_low_malang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_low_malang_train$RR), order.by=data_low_malang_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.01, C = 1

fit_beras_low_malang.SVR <- ARml(ts(data_low_malang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(0.05,0.1,0.5,1,5),
  sigma=c(0.01, 0.005, 0.05, 0.025, 0.0025)
),xreg=xts(log1p(data_low_malang_train$RR), order.by=data_low_malang_train$tanggal))

plot(fit_beras_low_malang.SVR$model)
#Fitting sigma = 0.05, C = 0.1
```

```{r forecast}

forecast_low_malang.SVR <- caretForecast::forecast(fit_beras_low_malang.SVR, level = NULL, xreg = xts(log1p(data_low_malang_test$RR), order.by = data_low_malang_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_low_malang.TF) + ylab("harga") +
    autolayer(ts(data_low_malang$harga),series="Real data"),
  autoplot(forecast_low_malang.SVR) + ylab("harga") +
    autolayer(ts(data_low_malang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_low_malang_test$tanggal,
      y = as.numeric(data_low_malang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_low_malang_test$tanggal,
      y = as.numeric(forecast_low_malang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Low Quailty Rice Price Malang")

```

```{r akurasi model}
accuracy(forecast_low_malang.TF,data_low_malang_test$harga)
accuracy(forecast_low_malang.SVR,data_low_malang_test$harga)

MAPE(forecast_low_malang.TF_join,data_low_malang_test$harga)
MAPE(forecast_low_malang.SVR$mean,data_low_malang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_low_malang.TF <- 
caret::postResample(data_low_malang_train$harga,fit_beras_low_malang.TF$fitted)

postFit_beras_low_malang.SVR <- 
caret::postResample(data_low_malang_train$harga[-c(1:fit_beras_low_malang.SVR$max_lag+1)],na.omit(fit_beras_low_malang.SVR$fitted))

postFit_beras_low_malang <-
  matrix(c(postFit_beras_low_malang.TF["RMSE"],
                postFit_beras_low_malang.TF["MAE"],
                postFit_beras_low_malang.TF["Rsquared"],
                postFit_beras_low_malang.SVR["RMSE"],
                postFit_beras_low_malang.SVR["MAE"],
                postFit_beras_low_malang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_low_malang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_low_malang) <- c('ARIMAX','SVR')
postFit_beras_low_malang <- round(as.table(postFit_beras_low_malang),4)

###Hasil Error data Test
(postTest_beras_low_malang.TF <- 
caret::postResample(data_low_malang_test$harga,forecast_low_malang.TF_join))

(postTest_beras_low_malang.SVR <- 
caret::postResample(data_low_malang_test$harga,forecast_low_malang.SVR$mean))

postTest_beras_low_malang <-
  matrix(c(postTest_beras_low_malang.TF["RMSE"],
                postTest_beras_low_malang.TF["MAE"],
                postTest_beras_low_malang.TF["Rsquared"],
                postTest_beras_low_malang.SVR["RMSE"],
                postTest_beras_low_malang.SVR["MAE"],
                postTest_beras_low_malang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_low_malang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_low_malang) <- c('ARIMAX','SVR')
postTest_beras_low_malang <- round(as.table(postTest_beras_low_malang),4)

paste0("Model Fitting Error")
postFit_beras_low_malang
paste0("Model Testing Error")
postTest_beras_low_malang

# plot(beras_low_malang.m1$x,col="red") +
# lines(fitted(beras_low_malang.m1),col="blue")
# 
# plot(fit_beras_low_malang.lm$x,col="red") +
# lines(fitted(fit_beras_low_malang.lm),col="blue")


```
###Malang - Med
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_med_malang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_med_malang.lm <- lm(log(harga) ~ log1p(RR), data=data_med_malang_train)

coeftest(fit_beras_med_malang.lm)
summary(fit_beras_med_malang.lm)
# auto.arima(data_med_malang_train[,"harga"], xreg = log1p(data_med_malang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_med_malang.lm$residuals)
auto.arima(fit_beras_med_malang.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_med_malang.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_med_malang.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_med_malang.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_med_malang.lm$residuals),1), ma.max=7) 

temp.model <- list(c(0,1,1),c(1,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_med_malang.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,1)



#model arima
res_beras_med_malang.m1 <- 
  Arima(fit_beras_med_malang.lm$residuals, 
        order=c(1,1,1))
summary(res_beras_med_malang.m1)
coeftest(res_beras_med_malang.m1)
checkresiduals(res_beras_med_malang.m1)
shapiro.test(res_beras_med_malang.m1$residuals)
#white noise

Arima(ts(data_med_malang_train$harga),
      order = c(0,1,1),
      xreg = ts(log1p(data_med_malang_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_med_malang <- 
  prewhiten(x=data_med_malang_train$harga,
            y=data_med_malang_train$RR, 
            x.model = Arima(data_med_malang_train$harga, order = c(1,0,0)))
ccf_med_malang$ccf 

# b=0
xlag_med_malang <- ts(Lag(log1p(data_med_malang_train[,"RR"]),0))
xlag_med_malang[is.na(xlag_med_malang)]=0
fit_beras_med_malang.TFX_temp <-
  arimax(ts(log(data_med_malang_train[,"harga"])),
         order=c(0,1,1),
         xtransf = xlag_med_malang, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_med_malang.TFX_temp)


fit_beras_med_malang.TF <- 
  Arima(data_med_malang_train$harga,
        xreg = log1p(data_med_malang_train[,"RR"]),
        lambda = 0,
        order=c(0,1,1))

checkresiduals(fit_beras_med_malang.TF)
shapiro.test(fit_beras_med_malang.TF$residuals)
autoplot(fit_beras_med_malang.TF)
summary(fit_beras_med_malang.TF)
coeftest(fit_beras_med_malang.TF)

```
```{r ARIMAX, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_med_malang_train$harga)),
#         xreg=log1p(data_med_malang_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_med_malang.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

forecast_med_malang.TF <-
  forecast::forecast(fit_beras_med_malang.TF,
                     xreg = ts(log1p(data_med_malang_test$RR)))

#Tidak ada arch effect (homokedastisitas)

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_med_malang_test[,"tanggal"],
      y = as.numeric(data_med_malang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_malang_test[,"tanggal"],
      y = as.numeric(forecast_med_malang.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Malang")


#Check QQ-norm
# archres_med_malang <- fit_beras_med_malang.TF$residuals/fit_beras_med_malang.garch@fitted
# qqnorm(archres_med_malang)
# qqline(archres_med_malang)

```



```{r SVR}
model_temp <- ARml(ts(data_med_malang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1,3)
),xreg=xts(log1p(data_med_malang_train$RR), order.by=data_med_malang_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.1, C = 10 or sigma = 3, C = 100

fit_beras_med_malang.SVR <- ARml(ts(data_med_malang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(60,80,100,150,200),
  sigma=c(1,2,3,4,5)
),xreg=xts(log1p(data_med_malang_train$RR), order.by=data_med_malang_train$tanggal))

plot(fit_beras_med_malang.SVR$model)
#Fitting sigma = 3, C = 60
```

```{r forecast}
forecast_med_malang.TF <-
  forecast::forecast(fit_beras_med_malang.TF,
                     xreg = ts(log1p(data_med_malang_test$RR)))


forecast_med_malang.SVR <- caretForecast::forecast(fit_beras_med_malang.SVR, level = NULL, xreg = xts(log1p(data_med_malang_test$RR), order.by = data_med_malang_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_med_malang.TF) + ylab("harga") +
    autolayer(ts(data_med_malang$harga),series="Real data"),
  autoplot(forecast_med_malang.SVR) + ylab("harga") +
    autolayer(ts(data_med_malang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_med_malang_test$tanggal,
      y = as.numeric(data_med_malang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_med_malang_test$tanggal,
      y = as.numeric(forecast_med_malang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted Medium Quailty Rice Price Malang")

```

```{r akurasi model}
accuracy(forecast_med_malang.TF,data_med_malang_test$harga)
accuracy(forecast_med_malang.SVR,data_med_malang_test$harga)

MAPE(forecast_med_malang.TF$mean,data_med_malang_test$harga)
MAPE(forecast_med_malang.SVR$mean,data_med_malang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_med_malang.TF <- 
caret::postResample(data_med_malang_train$harga,fit_beras_med_malang.TF$fitted)

postFit_beras_med_malang.SVR <- 
caret::postResample(data_med_malang_train$harga[-c(1:fit_beras_med_malang.SVR$max_lag+1)],na.omit(fit_beras_med_malang.SVR$fitted))

postFit_beras_med_malang <-
  matrix(c(postFit_beras_med_malang.TF["RMSE"],
                postFit_beras_med_malang.TF["MAE"],
                postFit_beras_med_malang.TF["Rsquared"],
                postFit_beras_med_malang.SVR["RMSE"],
                postFit_beras_med_malang.SVR["MAE"],
                postFit_beras_med_malang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_med_malang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_med_malang) <- c('ARIMAX','SVR')
postFit_beras_med_malang <- round(as.table(postFit_beras_med_malang),4)

###Hasil Error data Test
(postTest_beras_med_malang.TF <- 
caret::postResample(data_med_malang_test$harga,forecast_med_malang.TF$mean))

(postTest_beras_med_malang.SVR <- 
caret::postResample(data_med_malang_test$harga,forecast_med_malang.SVR$mean))

postTest_beras_med_malang <-
  matrix(c(postTest_beras_med_malang.TF["RMSE"],
                postTest_beras_med_malang.TF["MAE"],
                postTest_beras_med_malang.TF["Rsquared"],
                postTest_beras_med_malang.SVR["RMSE"],
                postTest_beras_med_malang.SVR["MAE"],
                postTest_beras_med_malang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_med_malang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_med_malang) <- c('ARIMAX','SVR')
postTest_beras_med_malang <- round(as.table(postTest_beras_med_malang),4)

paste0("Model Fitting Error")
postFit_beras_med_malang
paste0("Model Testing Error")
postTest_beras_med_malang

# plot(beras_med_malang.m1$x,col="red") +
# lines(fitted(beras_med_malang.m1),col="blue")
# 
# plot(fit_beras_med_malang.lm$x,col="red") +
# lines(fitted(fit_beras_med_malang.lm),col="blue")


```


###Malang - High
```{r plot dan regresi model}
#plot harga beras dan curah hujan
autoplot(ts(data_high_malang_train[,c(3,8)],freq=365.25/7, 
           start=decimal_date(ymd("2017-07-31"))),
         facets=TRUE)+ylab("") #harga beras dan curah hujan

#dibutuhkan log transform pada kedua data

fit_beras_high_malang.lm <- lm(log(harga) ~ log1p(RR), data=data_high_malang_train)

coeftest(fit_beras_high_malang.lm)
summary(fit_beras_high_malang.lm)
# auto.arima(data_high_malang_train[,"harga"], xreg = log1p(data_high_malang_train[,"RR"]), lambda = 0, seasonal = F)

ggtsdisplay(fit_beras_high_malang.lm$residuals)
auto.arima(fit_beras_high_malang.lm$residuals, stepwise = T, approximation = F)
ggtsdisplay(diff(ts(fit_beras_high_malang.lm$residuals),1))

```

```{r ARIMA}
#menentukan orde dari ARIMA(p,d,q) untuk residual dari model regresi

#stationarity test
adf.test(fit_beras_high_malang.lm$residuals) #data harga beras tidak stasioner
adf.test(diff(ts(fit_beras_high_malang.lm$residuals),1)) #data harga beras stasioner

eacf(diff(ts(fit_beras_high_malang.lm$residuals),1), ma.max=7) 

temp.model <- list(c(0,1,1),c(1,1,1))
best_model <- matrix(0,length(temp.model),2)
colnames(best_model) <- c('AIC','BIC')
rownames(best_model) <- temp.model
for (i in 1:length(temp.model)){
  fit <- arima(fit_beras_high_malang.lm$residuals, 
        order=temp.model[[i]])
    best_model[i,1] = AIC(fit)
    best_model[i,2] = BIC(fit)
}
best_model #ARIMA(0,1,1)



#model arima
res_beras_high_malang.m1 <- 
  Arima(fit_beras_high_malang.lm$residuals, 
        order=c(1,1,1))
summary(res_beras_high_malang.m1)
coeftest(res_beras_high_malang.m1)
checkresiduals(res_beras_high_malang.m1)
shapiro.test(res_beras_high_malang.m1$residuals)
#white noise

Arima(ts(data_high_malang_train$harga),
      order = c(0,1,1),
      xreg = ts(log1p(data_high_malang_train$RR)),
      lambda = 0)

```

```{r Fungsi Transfer 1}
##plot grafik CCF (untuk menentukan orde dari b,r,s)
#variabel independen = harga
#variabel terkait = curah hujan

ccf_high_malang <- 
  prewhiten(x=data_high_malang_train$harga,
            y=data_high_malang_train$RR, 
            x.model = Arima(data_high_malang_train$harga, order = c(1,0,0)))
ccf_high_malang$ccf 

# b=0
xlag_high_malang <- ts(Lag(log1p(data_high_malang_train[,"RR"]),0))
xlag_high_malang[is.na(xlag_high_malang)]=0
fit_beras_high_malang.TFX_temp <-
  arimax(ts(log(data_high_malang_train[,"harga"])),
         order=c(0,1,1),
         xtransf = xlag_high_malang, #b
         transfer = list(c(0,10)), #List with (r,s) orders
         include.mean = TRUE,
         method="ML") 

coeftest(fit_beras_high_malang.TFX_temp)


fit_beras_high_malang.TF <- 
  Arima(data_high_malang_train$harga,
        xreg = log1p(data_high_malang_train[,"RR"]),
        lambda = 0,
        order=c(0,1,1))

checkresiduals(fit_beras_high_malang.TF)
shapiro.test(fit_beras_high_malang.TF$residuals)
autoplot(fit_beras_high_malang.TF)
summary(fit_beras_high_malang.TF)
coeftest(fit_beras_high_malang.TF)

```


```{r ARIMAX, warning=FALSE}
# aTSA::arch.test(arima(ts(log(data_high_malang_train$harga)),
#         xreg=log1p(data_high_malang_train$RR),
#         order=c(0,1,1)))

arch.result <- matrix(0,6,3)
for (i in 1:6){
  arch <- FinTS::ArchTest(fit_beras_high_malang.TF$residuals, lags = 4*i)
  arch.result[i,1] <- arch$parameter
  arch.result[i,2] <- arch$statistic
  arch.result[i,3] <- arch$p.value
}
arch.result

forecast_high_malang.TF <-
  forecast::forecast(fit_beras_high_malang.TF,
                     xreg = ts(log1p(data_high_malang_test$RR)))

#Tidak ada arch effect (homokedastisitas)

#plot forecasting ARIMAX
ggplot() +
  geom_line(
    aes(
      x = data_high_malang_test[,"tanggal"],
      y = as.numeric(data_high_malang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_malang_test[,"tanggal"],
      y = as.numeric(forecast_high_malang.TF$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted highium Quailty Rice Price Malang")


#Check QQ-norm
# archres_high_malang <- fit_beras_high_malang.TF$residuals/fit_beras_high_malang.garch@fitted
# qqnorm(archres_high_malang)
# qqline(archres_high_malang)

```

```{r SVR}
model_temp <- ARml(ts(data_high_malang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, pre_process = c('center', 'scale'), tune_grid = expand.grid(
  C=c(1,10,100,1000),
  sigma=c(0.001, 0.01, 0.1,1)
),xreg=xts(log1p(data_high_malang_train$RR), order.by=data_high_malang_train$tanggal))


plot(model_temp$model)
#Fitting sigma = 0.1, C = 1

fit_beras_high_malang.SVR <- ARml(ts(data_high_malang_train$harga), maxlag = 12, caret_method = "svmRadialSigma",lambda = 0, preProcess = "scale", tune_grid = expand.grid(
  C=c(0.05,0.1,0.5,1,5),
  sigma=c(0.03,0.05,0.1, 0.15, 0.2)
),xreg=xts(log1p(data_high_malang_train$RR), order.by=data_high_malang_train$tanggal))

plot(fit_beras_high_malang.SVR$model)
#Fitting sigma = 0.2, C = 0.1
```

```{r forecast}
forecast_high_malang.TF <-
  forecast::forecast(fit_beras_high_malang.TF,
                     xreg = ts(log1p(data_high_malang_test$RR)))


forecast_high_malang.SVR <- caretForecast::forecast(fit_beras_high_malang.SVR, level = NULL, xreg = xts(log1p(data_high_malang_test$RR), order.by = data_high_malang_test$tanggal))


gridExtra::grid.arrange(
  autoplot(forecast_high_malang.TF) + ylab("harga") +
    autolayer(ts(data_high_malang$harga),series="Real data"),
  autoplot(forecast_high_malang.SVR) + ylab("harga") +
    autolayer(ts(data_high_malang$harga),series="Real data")
  ) 

ggplot() +
  geom_line(
    aes(
      x = data_high_malang_test$tanggal,
      y = as.numeric(data_high_malang_test$harga), 
      color = "Actual"
    )
  ) +
  geom_line(
    aes(
      x = data_high_malang_test$tanggal,
      y = as.numeric(forecast_high_malang.SVR$mean),
      color = "Predicted"
    )
  ) + scale_color_manual(name="",                     breaks=c('Actual', 'Predicted'),                     values=c('Actual'='black', 'Predicted'='red')) + xlab("date") + ylab("price") + ggtitle("Actual vs Predicted High Quailty Rice Price Malang")

```

```{r akurasi model}
accuracy(forecast_high_malang.TF,data_high_malang_test$harga)
accuracy(forecast_high_malang.SVR,data_high_malang_test$harga)

MAPE(forecast_high_malang.TF$mean,data_high_malang_test$harga)
MAPE(forecast_high_malang.SVR$mean,data_high_malang_test$harga)

#hitung nilai mean error dan R^2

###Hasil error data fitting
postFit_beras_high_malang.TF <- 
caret::postResample(data_high_malang_train$harga,fit_beras_high_malang.TF$fitted)

postFit_beras_high_malang.SVR <- 
caret::postResample(data_high_malang_train$harga[-c(1:fit_beras_high_malang.SVR$max_lag+1)],na.omit(fit_beras_high_malang.SVR$fitted))

postFit_beras_high_malang <-
  matrix(c(postFit_beras_high_malang.TF["RMSE"],
                postFit_beras_high_malang.TF["MAE"],
                postFit_beras_high_malang.TF["Rsquared"],
                postFit_beras_high_malang.SVR["RMSE"],
                postFit_beras_high_malang.SVR["MAE"],
                postFit_beras_high_malang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postFit_beras_high_malang) <- c('RMSE','MAE','R^2')
rownames(postFit_beras_high_malang) <- c('ARIMAX','SVR')
postFit_beras_high_malang <- round(as.table(postFit_beras_high_malang),4)

###Hasil Error data Test
postTest_beras_high_malang.TF <- 
caret::postResample(data_high_malang_test$harga,forecast_high_malang.TF$mean)

(postTest_beras_high_malang.SVR <- 
caret::postResample(data_high_malang_test$harga,forecast_high_malang.SVR$mean))

postTest_beras_high_malang <-
  matrix(c(postTest_beras_high_malang.TF["RMSE"],
                postTest_beras_high_malang.TF["MAE"],
                postTest_beras_high_malang.TF["Rsquared"],
                postTest_beras_high_malang.SVR["RMSE"],
                postTest_beras_high_malang.SVR["MAE"],
                postTest_beras_high_malang.SVR["Rsquared"]
                ), ncol=3, byrow=TRUE)
colnames(postTest_beras_high_malang) <- c('RMSE','MAE','R^2')
rownames(postTest_beras_high_malang) <- c('ARIMAX','SVR')
postTest_beras_high_malang <- round(as.table(postTest_beras_high_malang),4)

paste0("Model Fitting Error")
postFit_beras_high_malang
paste0("Model Testing Error")
postTest_beras_high_malang

# plot(beras_high_malang.m1$x,col="red") +
# lines(fitted(beras_high_malang.m1),col="blue")
# 
# plot(fit_beras_high_malang.lm$x,col="red") +
# lines(fitted(fit_beras_high_malang.lm),col="blue")


```


